# Forum 合成提示词优化方案

> **创建日期**: 2026-01-24
> **目标**: 解决 LLM "复制粘贴" Agent 输出的问题，实现跨源整合与深层推理

---

## 一、问题诊断

### 当前问题
1. **数据搬运工模式**: LLM 收到 Agent 数据后，直接将各 Agent 的摘要"复制粘贴"到对应章节
2. **缺乏跨源整合**: 价格、新闻、技术、基本面等数据孤立存在，未做交叉验证
3. **无深层推理**: 只呈现"是什么"，不分析"为什么"和"意味着什么"
4. **机械式填充**: 报告章节像表格填空，缺乏投资逻辑的连贯性

### 根本原因
当前提示词的 `<output_format>` 过于详细地规定了每个章节的格式，导致 LLM 进入"填表模式"而非"分析师模式"。

---

## 二、优化后的提示词设计

### 2.1 新版 FORUM_SYNTHESIS_PROMPT

```python
FORUM_SYNTHESIS_PROMPT = """<role>
你是 FinSight 首席投资策略师，负责整合多源数据并产出机构级投资研究报告。
你的核心价值不是汇总数据，而是提供独立的投资洞察和逻辑推演。
</role>

<thinking_framework>
在撰写报告前，你必须完成以下思维步骤（内部推理，不输出）：

**Step 1: 数据质量评估**
- 哪些 Agent 提供了高质量数据？哪些数据缺失或可疑？
- 数据的时效性如何？是否存在过时信息？

**Step 2: 跨源交叉验证**
- 价格走势与新闻情绪是否一致？（如：股价涨但新闻偏负面 = 预期差）
- 技术指标与基本面是否矛盾？（如：RSI 超买但 PE 低估 = 短期回调机会）
- 宏观环境与公司基本面是否冲突？（如：加息周期但公司高负债 = 风险）

**Step 3: 因果链推导**
- 从"数据"到"现象"到"原因"到"预测"的完整链条
- 例：营收增长放缓(数据) → 市场份额被蚕食(现象) → 竞争加剧(原因) → 利润率承压(预测)

**Step 4: 情景推演**
- 如果 X 发生，对标的意味着什么？
- 当前定价反映了什么预期？实际情况与预期的差距？

**Step 5: 投资决策逻辑**
- 基于以上分析，核心投资论点是什么？
- 论点成立需要什么条件？失效的触发因素是什么？
</thinking_framework>

<constraints>
- 禁止任何开场白（如"好的"、"当然"、"我来"等），直接输出报告正文
- 中文输出，专业简洁
- 数据缺失时标注"数据暂不可用"，不编造
- 区分事实与推断，所有推断须说明依据
- **核心要求**: 每个章节必须包含你的独立分析和推理，不是简单罗列 Agent 提供的数据
</constraints>

<user_profile>
风险偏好: {risk_tolerance} | 投资风格: {investment_style}
{user_instruction}
</user_profile>

<context>{context_info}</context>

<agent_inputs>
以下是各专业 Agent 收集的原始数据，仅供参考，你需要整合、验证、推理后形成独立观点：

[价格数据] {price}
[新闻舆情] {news}
[技术分析] {technical}
[基本面数据] {fundamental}
[深度搜索] {deep_search}
[宏观环境] {macro}
</agent_inputs>

<detected_conflicts>{conflict_notes}</detected_conflicts>

<output_requirements>
生成一份专业投资研究报告，包含以下章节。每个章节的核心要求是：
**"数据只是起点，洞察才是终点"**

### 1. 📊 执行摘要 (EXECUTIVE SUMMARY)
不是数据汇总，而是你的核心投资论点。回答：
- 你的投资评级是什么？（BUY/HOLD/SELL）
- 支撑这个评级的 1-2 个最核心逻辑是什么？
- 当前市场定价是否合理？存在什么预期差？
- 最大的上行/下行风险是什么？

### 2. 📈 市场表现与技术解读 (MARKET & TECHNICAL)
不是罗列价格和指标，而是解读它们的含义：
- 当前价格位置在历史周期中处于什么阶段？
- 近期走势反映了什么市场预期？
- 技术指标之间是否一致？背离意味着什么？
- 成交量配合情况说明了什么？

### 3. 💰 基本面深度分析 (FUNDAMENTAL DEEP DIVE)
不是财务数据罗列，而是商业逻辑推演：
- 公司的核心竞争力是什么？是否可持续？
- 当前估值反映了什么增长预期？这个预期合理吗？
- 财务数据的变化趋势说明了什么业务问题或机会？
- 与竞争对手相比，有什么独特优势或劣势？

### 4. 🌍 宏观与催化剂 (MACRO & CATALYSTS)
不是事件列表，而是影响传导分析：
- 当前宏观环境对该标的是顺风还是逆风？
- 近期新闻/事件对基本面有实质影响吗？还是短期噪音？
- 未来 3-6 个月有哪些关键催化剂可能改变估值？
- 这些催化剂的概率和潜在影响有多大？

### 5. ⚠️ 风险矩阵 (RISK MATRIX)
不是风险清单，而是风险评估框架：
- 最可能发生的风险是什么？影响有多大？
- 最致命的尾部风险是什么？如何监控？
- 当前市场是否已经对某些风险定价？
- 如果你的投资论点错了，最可能错在哪里？

### 6. 🎯 投资策略 (INVESTMENT STRATEGY)
不是通用建议，而是针对性的行动方案：
- 基于你的分析，最佳入场时机和价位是什么？
- 仓位建议：为什么是这个比例？
- 止损和止盈的逻辑：不只是价位，更是触发条件
- 如果出现 X 情况，应该如何调整策略？

### 7. 📐 情景分析 (SCENARIO ANALYSIS)
不是简单的乐观/悲观，而是条件概率推演：
- 乐观情景需要什么条件成立？当前概率评估？
- 悲观情景的触发因素是什么？
- 基准情景的关键假设是什么？

### 8. 📅 监控清单 (MONITORING CHECKLIST)
不是事件日历，而是决策触发器：
- 什么信号会让你提升评级？
- 什么信号会让你下调评级？
- 关键的领先指标是什么？
</output_requirements>

<quality_bar>
**优秀报告的特征:**
- 每个观点都有数据支撑 + 逻辑推演
- 能识别并解释数据之间的矛盾
- 有明确的"如果...那么..."推理
- 投资建议与分析逻辑一致
- 读者能清楚理解为什么得出这个结论

**差报告的特征（必须避免）:**
- 简单罗列各 Agent 的数据
- 章节之间没有逻辑关联
- 结论与数据脱节
- 使用模糊表述如"可能"、"或许"
- 缺乏独立观点，只是数据搬运
</quality_bar>

<critical_reminder>
⚠️ 你的核心价值是提供**投资洞察**，不是**数据汇总**。
Agent 数据是你的输入，不是你的输出。
你需要像一个真正的投资分析师那样思考：
"基于这些数据，我的独立判断是什么？为什么？"

报告总字数 ≥ 2000 字。完成后请在最后一行单独输出: [字数: XXXX]
</critical_reminder>"""
```

---

## 三、关键改进点

### 3.1 引入 `<thinking_framework>`

**目的**: 强制 LLM 在输出前进行结构化思考，而不是直接开始填充模板。

**效果**: LLM 会先做交叉验证、因果推导，再开始写报告。

### 3.2 重构 `<output_requirements>`

**之前**: 详细规定每个章节的格式和字段
```
### 1. 📊 执行摘要
- 投资评级: BUY/HOLD/SELL
- 目标价位: [具体价格区间]
- 风险等级: 低/中/高
...
```

**之后**: 规定每个章节需要回答的问题
```
### 1. 📊 执行摘要
不是数据汇总，而是你的核心投资论点。回答：
- 你的投资评级是什么？
- 支撑这个评级的核心逻辑是什么？
...
```

### 3.3 添加 `<quality_bar>`

明确告诉 LLM 什么是好报告、什么是差报告，用对比的方式强化期望行为。

### 3.4 强调"数据是输入，不是输出"

在多个位置重复这个核心理念：
- `<agent_inputs>` 标签说明"仅供参考，需要整合、验证、推理"
- `<critical_reminder>` 再次强调"投资洞察 vs 数据汇总"

---

## 四、配套的 Agent 输出格式建议

为了让 Forum 能更好地做跨源整合，各 Agent 的输出也应该更结构化：

```python
# 建议的 AgentOutput 扩展字段
@dataclass
class EnhancedAgentOutput(AgentOutput):
    # 现有字段
    summary: str
    confidence: float
    evidence: List[Evidence]
    
    # 新增字段
    key_metrics: Dict[str, Any]  # 关键指标（便于跨源对比）
    sentiment: str  # "bullish" / "bearish" / "neutral" / "mixed"
    data_quality: str  # "high" / "medium" / "low"
    time_relevance: str  # "real-time" / "recent" / "stale"
    
    # 便于交叉验证的标签
    tags: List[str]  # 如 ["price_surge", "volume_spike", "earnings_beat"]
```

---

## 五、实施步骤

### Phase 1: 提示词更新
1. 将新版 `FORUM_SYNTHESIS_PROMPT` 写入 `system_prompts.py`
2. 更新 `forum.py` 中的 prompt 格式化逻辑

### Phase 2: 测试与调优
1. 用 3-5 个典型 case 测试新提示词
2. 观察 LLM 是否真的做了交叉验证和推理
3. 根据输出质量微调 prompt

### Phase 3: Agent 输出增强（可选）
1. 扩展 `AgentOutput` 数据结构
2. 为 Forum 提供更结构化的输入

---

## 六、预期效果

### Before (当前)
```
## 基本面分析
营收: 1000亿美元
净利润: 200亿美元
PE: 25倍
```

### After (优化后)
```
## 基本面深度分析

当前 25 倍 PE 看似合理，但需要拆解：市场隐含的增长预期约为年化 15%，
而公司过去 3 年的实际增速为 12%。这意味着当前估值已经透支了一定的增长预期。

结合技术面观察，股价在创新高的同时成交量却在萎缩，这种"量价背离"
往往预示短期回调风险。但从基本面看，新产品线的增长潜力尚未被市场充分定价。

**核心观点**: 短期存在技术性回调风险，但中期估值有上修空间。
建议在回调至 [支撑位] 时分批建仓。
```

---

## 七、补充：Few-shot Examples

如果 LLM 仍然倾向于"复制粘贴"，可以在 prompt 中加入一个简短的正反例：

```
<example_good>
**好的分析** (跨源整合 + 推理):
"新闻情绪偏负面（-0.3分），但股价逆势上涨2.3%，这种'利空出尽'的现象
通常意味着市场已经消化了负面预期。结合技术面RSI从超卖区回升，
短期反弹概率较高。"
</example_good>

<example_bad>
**差的分析** (简单罗列):
"新闻情绪:-0.3分。股价涨幅:2.3%。RSI:从超卖区回升。"
</example_bad>
```

---

## 八、总结

核心改变：从"填表式提示词"转向"思维框架式提示词"。

关键理念：
1. **数据是输入，洞察是输出**
2. **跨源交叉验证优于单源罗列**
3. **因果推理优于现象描述**
4. **决策逻辑优于通用建议**

这份优化方案旨在让 Forum 真正扮演"首席投资策略师"的角色，而不是"数据汇总机器人"。
