# FinSight ç»ˆææ¶æ„è®¾è®¡ï¼šæ™ºèƒ½é‡‘èåˆä¼™äºº

> **æ›´æ–°æ—¥æœŸ**: 2026-01-24
> **æ ¸å¿ƒæ„¿æ™¯**: ä»è¢«åŠ¨é—®ç­”çš„"å·¥å…·äºº"å‡çº§ä¸ºä¸»åŠ¨æœåŠ¡çš„"æ™ºèƒ½åˆä¼™äºº"
> **æ¶æ„æ¨¡å¼**: Supervisor Agent (åè°ƒè€…æ¨¡å¼)
>
> **è¿‘æœŸåŒæ­¥**:
> - ReportIR citations å¢åŠ  confidence / freshness_hours å­—æ®µï¼ˆP0-2ï¼‰
> - News/Macro å›é€€ç»“æ„åŒ–è¾“å‡ºï¼Œé¿å… raw æ–‡æœ¬è¿›å…¥æŠ¥å‘Šï¼ˆP0-3ï¼‰
> - get_company_news æ”¹ä¸ºç»“æ„åŒ–åˆ—è¡¨ï¼ŒNewsAgent/SupervisorAgent åŒæ­¥é€‚é…ï¼ˆP1-1ï¼‰
> - SSRF é˜²æŠ¤æ‰©å±•è‡³ DeepSearch + fetch_url_contentï¼ˆP1-2ï¼‰
> - pytest æ”¶é›† backend/tests + test/ï¼ˆä¸å†æ ‡è®° legacyï¼‰
> - PlanIR + Executor ä¸ EvidencePolicy è½åœ°ï¼ˆè®¡åˆ’æ¨¡æ¿/æ‰§è¡Œ trace/å¼•ç”¨æ ¡éªŒï¼‰
> - DataContext ç»Ÿä¸€ as_of/currency/adjustment å¹¶è¾“å‡ºä¸€è‡´æ€§å‘Šè­¦ï¼ˆP0-27ï¼‰
> - BudgetManager é™åˆ¶å·¥å…·è°ƒç”¨/è½®æ¬¡/è€—æ—¶é¢„ç®—ï¼Œé¢„ç®—å¿«ç…§å¯è¿½æº¯ï¼ˆP0-28ï¼‰
> - SecurityGateï¼šé‰´æƒ + é™æµ + å…è´£å£°æ˜æ¨¡æ¿è½åœ°ï¼ˆP0-29ï¼‰
> - Cache æŠ–åŠ¨ + è´Ÿç¼“å­˜ï¼ŒCircuitBreaker æ”¯æŒåˆ†æºé˜ˆå€¼
> - Trace è§„èŒƒåŒ–è¾“å‡º + /metrics å¯è§‚æµ‹æ€§å…¥å£
> - æ–°å¢ Need-Agent Gateï¼šå¯é æ€§ä¼˜å…ˆè·¯ç”± + Trace è®°å½•æ˜¯å¦è°ƒç”¨ Agent
> - Evidence Poolï¼šå¤–éƒ¨æ•°æ®/å·¥å…·è°ƒç”¨æ—¶è¿”å›è¯æ®æ± å¹¶åœ¨å‰ç«¯å±•ç¤º
> - News/Report è¾“å‡ºåŠ å…¥â€œæ€»è§ˆ/ç»“è®ºâ€æ‘˜è¦ï¼Œé˜²æ­¢å †å ä¿¡æ¯
> - å¤š ticker å¯¹æ¯”è‡ªåŠ¨è¡¥é½å›¾è¡¨æ ‡è®°ï¼ˆå¤šå›¾æˆ–åˆå›¾ï¼‰
> - é‡‘èç±»æœç´¢ç¦æ­¢ Wikipedia å…œåº•ï¼Œé¿å…æ— å…³å†…å®¹

> - Split backend/tools.py into backend/tools/ (search/news/price/financial/macro/web); keep backend.tools compatibility
> - Config entry unified: backend/llm_config.py uses user_config.json > .env; llm_service uses same source
> - Core backend logging migrated from print to logging (API/Agents/Services/Orchestration)
---

## ä¸€ã€æ¶æ„å…¨æ™¯å›¾ (The Big Picture)

FinSight é‡‡ç”¨ **Supervisor Agent åè°ƒè€…æ¨¡å¼**ï¼Œå®ç°ä¸šç•Œæ ‡å‡†çš„å¤š Agent åä½œæ¶æ„ã€‚

```mermaid
flowchart TB
    subgraph Frontend["å‰ç«¯ (React + TS)"]
        UI["ChatList + StockChart"]
        EP["Evidence Pool"]
        Profile["UserProfile"]
        Settings["Settings Modal<br/>æ¨¡å¼åˆ‡æ¢"]
    end

    subgraph Backend["åç«¯ (FastAPI + LangGraph)"]
        API["/chat/stream API"]
        CR["ConversationRouter<br/>å¯¹è¯è·¯ç”±"]
        Gate["Need-Agent Gate<br/>å¯é æ€§ä¼˜å…ˆ"]
        CH["ChatHandler<br/>å¿«é€Ÿå“åº”"]

        subgraph SupervisorLayer["åè°ƒè€…å±‚ (Supervisor Agent)"]
            IC["IntentClassifier<br/>æ„å›¾åˆ†ç±»å™¨"]
            SA["SupervisorAgent<br/>åè°ƒè€…"]
        end

        subgraph Agents["å¤šAgentä¸“å®¶å›¢"]
            PA["PriceAgent<br/>(è¡Œæƒ…ä¸“å®¶)"]
            NA["NewsAgent<br/>(èˆ†æƒ…ä¸“å®¶+åæ€)"]
            TA["TechnicalAgent<br/>(æŠ€æœ¯åˆ†æå¸ˆ)"]
            FA["FundamentalAgent<br/>(åŸºæœ¬é¢ç ”ç©¶å‘˜)"]
            MA["MacroAgent<br/>(å®è§‚åˆ†æ)"]
            DS["DeepSearchAgent<br/>(æ·±åº¦ç ”æŠ¥)"]
        end

        subgraph Forum["å†³ç­–å±‚"]
            FH["ForumHost<br/>(é¦–å¸­æŠ•èµ„å®˜/å†²çªæ¶ˆè§£)"]
        end

        subgraph Infrastructure["åŸºç¡€è®¾æ–½"]
            ORC["ToolOrchestrator"]
            Cache["KV Cache"]
            CB["CircuitBreaker"]
            DC["DataContext"]
            BM["BudgetManager"]
            SG["SecurityGate"]
            MET["Metrics/Logging"]
        end
    end

    %% Data Flow
    UI --> API
    API --> CR
    CR --> Gate
    Gate -->|å¿«é€Ÿè·¯å¾„| CH
    Gate -->|éœ€è¦Agent| IC
    IC -->|æ„å›¾åˆ†ç±»| SA
    SA -->|ç®€å•æ„å›¾| ORC
    SA -->|å¤æ‚æ„å›¾| PA
    SA -->|å¤æ‚æ„å›¾| NA
    SA -->|å¤æ‚æ„å›¾| TA
    SA -->|å¤æ‚æ„å›¾| FA
    SA -->|å¤æ‚æ„å›¾| MA
    SA -->|å¤æ‚æ„å›¾| DS

    PA -->|AgentOutput| FH
    NA -->|AgentOutput| FH
    TA -->|AgentOutput| FH
    FA -->|AgentOutput| FH
    MA -->|AgentOutput| FH
    DS -->|AgentOutput| FH

    FH -->|ForumOutput| API
    SA -->|evidence_pool| API
    API --> EP
    ORC --> Cache
    ORC --> CB
    ORC --> DC
    SA --> BM
    API --> SG
    ORC --> MET
    API --> MET

```

---

## 1.1 Need-Agent Gateï¼ˆå¯é æ€§ä¼˜å…ˆé—¸é—¨ï¼‰

åœ¨å¯¹è¯æ¨¡å¼ä¸‹æ–°å¢ **Need-Agent Gate**ï¼Œç”¨äºå†³å®šâ€œæ˜¯å¦å‡çº§åˆ° Supervisor å¤š Agentâ€ï¼š

- **ç¡¬è§¦å‘**ï¼šæ—¶æ•ˆè¯ / å†³ç­–è¯ / å¯¹æ¯” / è´¢åŠ¡æŒ‡æ ‡ / æ–°é—»æƒ…ç»ª / å®è§‚äº‹ä»¶  
- **è½¯è§¦å‘**ï¼šä½ç½®ä¿¡åº¦ã€ticker ä¸æ¸…æ™°ã€å¤š ticker  
- **ç›®æ ‡**ï¼šå¯é æ€§ä¼˜å…ˆï¼Œå®å¯å¤šè°ƒç”¨ï¼Œä¹Ÿä¸æ¼è°ƒç”¨  
- **å¯è§£é‡Šæ€§**ï¼šTrace ä¸­æ˜ç¡®è®°å½•â€œæ˜¯å¦è°ƒç”¨ Agent + è§¦å‘åŸå›  + ç½®ä¿¡åº¦â€

## 1.2 Evidence Pool ä¸ Trace å¯è¿½æº¯

å½“è°ƒç”¨å·¥å…·/å¤–éƒ¨æ•°æ®æºæ—¶ï¼Œç³»ç»Ÿè¿”å› **evidence_pool**ï¼ˆè¯æ®æ± ï¼‰å¹¶åœ¨å‰ç«¯å±•ç¤ºï¼š

- **å†…å®¹**ï¼šæ¥æºã€URLã€æ—¶é—´æˆ³ã€ç½®ä¿¡åº¦ã€ç®€çŸ­æ‘˜è¦
- **åŸåˆ™**ï¼šå‡¡æ¶‰åŠå¤–éƒ¨æ•°æ®æˆ–æ¨æ–­ï¼Œå¿…é¡»é™„è¯æ®æ± ï¼›çº¯å¯¹è¯ä¸å¼ºåˆ¶
- **å±•ç¤º**ï¼šChat ä¸ Report å‡å¯å±•ç¤ºè¯æ®æ± ï¼Œé¿å…â€œæ— æºç»“è®ºâ€
- **å›ä¼ **ï¼šSupervisor ä¸å·¥å…·è¾“å‡ºç»Ÿä¸€é€ä¼ åˆ° SSE done ä¸ /chat å“åº”

## 1.3 News / Report â€œæ€»è§ˆâ€è¾“å‡º

- **News**ï¼šé»˜è®¤è¾“å‡ºâ€œè¦ç‚¹ + ç®€çŸ­æ€»è§ˆ + é£é™©æç¤ºâ€ï¼Œé¿å…å †å æ— å…³å†…å®¹
- **Report**ï¼šæ€»è§ˆæ”¾åœ¨å¼€å¤´ï¼Œåç»­åˆ†ç« èŠ‚å±•å¼€ï¼Œå¹¶æ ‡æ³¨å¼•ç”¨ä¸æ–°é²œåº¦

---

## äºŒã€Supervisor Agent æ¶æ„ (æ ¸å¿ƒåˆ›æ–°)

### 2.1 è®¾è®¡ç†å¿µ

**é—®é¢˜**: ä¼ ç»Ÿçš„"ç›´æ¥ Tool Calling"æ¨¡å¼å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

| åœºæ™¯ | ä¸åˆ†ç±»ï¼ˆç›´æ¥Tool Callingï¼‰ | å…ˆåˆ†ç±»å†å¤„ç† |
|------|---------------------------|-------------|
| "ä½ å¥½" | è°ƒç”¨LLM + ä¼ å·¥å…·åˆ—è¡¨ = è´µ | è§„åˆ™åŒ¹é…ç›´æ¥å›å¤ = å…è´¹ |
| "åˆ†æè‹¹æœ" | LLMå¯èƒ½é€‰é”™å·¥å…· | æ˜ç¡®èµ°REPORTæµç¨‹ |
| å‡ºé”™æ’æŸ¥ | ä¸çŸ¥é“å“ªé‡Œé”™äº† | çŸ¥é“æ˜¯å“ªä¸ªæ„å›¾çš„é—®é¢˜ |

**è§£å†³æ–¹æ¡ˆ**: ä¸‰å±‚æ··åˆæ„å›¾åˆ†ç±»æ¶æ„

```
ç”¨æˆ·è¾“å…¥
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸€å±‚ï¼šè§„åˆ™åŒ¹é…ï¼ˆå¿«é€Ÿé€šé“ï¼‰          â”‚
â”‚ - "ä½ å¥½/å¸®åŠ©/é€€å‡º" â†’ ç›´æ¥å¤„ç†         â”‚
â”‚ - å¤š ticker â†’ è‡ªåŠ¨è¯†åˆ«ä¸ºå¯¹æ¯”         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ æ²¡åŒ¹é…åˆ°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬äºŒå±‚ï¼šEmbeddingç›¸ä¼¼åº¦ + å…³é”®è¯åŠ æƒ  â”‚
â”‚ - è®¡ç®—ä¸å„æ„å›¾ä¾‹å¥çš„ç›¸ä¼¼åº¦            â”‚
â”‚ - å…³é”®è¯å‘½ä¸­ â†’ åŠ æƒ +0.12           â”‚
â”‚ - ç›¸ä¼¼åº¦ >= 0.75 â†’ ç›´æ¥åˆ†ç±»          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ç½®ä¿¡åº¦ä¸å¤Ÿ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ä¸‰å±‚ï¼šLLM Routerï¼ˆå…œåº•ï¼‰           â”‚
â”‚ - æŠŠå€™é€‰æ„å›¾å‘Šè¯‰LLM                  â”‚
â”‚ - LLMåšæœ€ç»ˆå†³ç­–                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 IntentClassifier (æ„å›¾åˆ†ç±»å™¨)

**æ–‡ä»¶**: `backend/orchestration/intent_classifier.py`

**å…³é”®è®¾è®¡**: å…³é”®è¯ä¸æ˜¯ç”¨æ¥"åŒ¹é…"çš„ï¼Œè€Œæ˜¯ç”¨æ¥**åŠ æƒ/æå‡ç½®ä¿¡åº¦**

```python
def _embedding_classify(self, query, query_lower, tickers):
    # 1. å…ˆç”¨ embedding ç®—è¯­ä¹‰ç›¸ä¼¼åº¦
    scores = self._embedding_classifier.compute_similarity(query)

    # 2. å…³é”®è¯å‘½ä¸­åˆ™åŠ åˆ†ï¼ˆä¸æ˜¯ç›´æ¥å†³å®šï¼‰
    for intent, keywords in KEYWORD_BOOST.items():
        if any(kw in query_lower for kw in keywords):
            scores[intent] += 0.12  # åŠ æƒï¼Œä¸æ˜¯ç›´æ¥é€‰æ‹©

    # 3. é€‰æœ€é«˜åˆ†ï¼Œç½®ä¿¡åº¦ä¸å¤Ÿåˆ™è°ƒç”¨ LLM
    ...
```

**Embedding æ¨¡å‹**: `paraphrase-multilingual-MiniLM-L12-v2` (æ”¯æŒä¸­è‹±æ–‡ï¼Œå»¶è¿ŸåŠ è½½)

**æ–¹æ¡ˆå¯¹æ¯”**:

| æ–¹æ¡ˆ | é€‚ç”¨åœºæ™¯ | å‡†ç¡®ç‡ | æˆæœ¬ |
|------|---------|--------|------|
| å…³é”®è¯åŒ¹é… | å¿«é€Ÿé€šé“ã€è¾…åŠ©åŠ æƒ | 60-70% | å…è´¹ |
| Embeddingç›¸ä¼¼åº¦ | ä¸»åŠ›æ–¹æ¡ˆ | 80-90% | ä½ |
| å¾®è°ƒåˆ†ç±»æ¨¡å‹ | å¤§è§„æ¨¡ç”Ÿäº§ | 95%+ | è®­ç»ƒæˆæœ¬é«˜ |
| LLM Router | å…œåº•ã€å¤æ‚åœºæ™¯ | 90%+ | é«˜ |

### 2.3 SupervisorAgent (åè°ƒè€…)

**æ–‡ä»¶**: `backend/orchestration/supervisor_agent.py`

**å¤„ç†ç­–ç•¥**:

| æ„å›¾ | å¤„ç†æ–¹å¼ | æˆæœ¬ |
|------|---------|------|
| GREETING | è§„åˆ™ç›´æ¥å›å¤ | å…è´¹ |
| PRICE/NEWS/SENTIMENT | ç›´æ¥è°ƒç”¨å·¥å…· | ä½ |
| TECHNICAL/FUNDAMENTAL/MACRO | å•Agent | ä¸­ |
| REPORT | å¤šAgent + Forum | é«˜ |
| COMPARISON | å·¥å…· | ä¸­ |
| SEARCH | LLM + æœç´¢ | ä¸­ |

### 2.4 NEWS å­æ„å›¾åˆ†ç±» (Sub-intent Classification) ğŸ†•

NEWS æ„å›¾è¿›ä¸€æ­¥ç»†åˆ†ä¸ºä¸¤ç§å­æ„å›¾ï¼š

| å­æ„å›¾ | è§¦å‘æ¡ä»¶ | å¤„ç†æ–¹å¼ | è¾“å‡º |
|--------|---------|---------|------|
| `fetch` | é»˜è®¤ | `_handle_news()` | æ–°é—»åˆ—è¡¨ + é“¾æ¥ |
| `analyze` | åŒ…å«åˆ†æç±»å…³é”®è¯ | `_handle_news_analysis()` | æ–°é—»æ‘˜è¦ + å¸‚åœºå½±å“ + æŠ•èµ„å¯ç¤º + é£é™©æç¤º |

**åˆ†æç±»å…³é”®è¯**: åˆ†æã€å½±å“ã€è§£è¯»ã€æ„å‘³ã€è¯„ä¼°ã€è¶‹åŠ¿ã€é¢„æµ‹ã€åˆ©å¥½ã€åˆ©ç©º...

```python
# ç¤ºä¾‹ï¼š_classify_news_subintent()
if any(kw in query for kw in ["åˆ†æ", "å½±å“", "è§£è¯»", "é¢„æµ‹"]):
    return "analyze"  # èµ°æ·±åº¦åˆ†æ
return "fetch"  # èµ°åŸå§‹æ–°é—»åˆ—è¡¨
```

### 2.5 å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç† ğŸ†•

ç³»ç»Ÿæ”¯æŒè·¨è½®å¯¹è¯çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼š

- **å‰ç«¯ä¼ é€’**: æœ€è¿‘ 6 æ¡æ¶ˆæ¯ä½œä¸º `history` å‚æ•°
- **åç«¯æå–**: `_extract_context_info()` æå–è‚¡ç¥¨ä»£ç å’Œæ‘˜è¦
- **æ™ºèƒ½åº”ç”¨**: å„ handler æ ¹æ®ä¸Šä¸‹æ–‡ä¼˜åŒ–å“åº”

---

## ä¸‰ã€æ ¸å¿ƒè§’è‰²å®šä¹‰

### 2.1 ä¸“å®¶ Agent å›¢é˜Ÿ (The Specialists)

| Agent | è§’è‰² | èŒè´£ | ç‰¹æ€§ |
|-------|------|------|------|
| **PriceAgent** | äº¤æ˜“å‘˜ | å®æ—¶ç›¯ç›˜ã€æŠ¥ä»·ã€ç›˜å£æ•°æ® | æé€Ÿå“åº” (TTL=30s)ï¼Œå¤šæºç†”æ–­ |
| **NewsAgent** | èˆ†æƒ…åˆ†æå¸ˆ | å…¨ç½‘æ–°é—»ã€ç¤¾äº¤åª’ä½“æƒ…ç»ª | **åæ€å¾ªç¯** (Reflection Loop) + å®˜æ–¹RSSä¼˜å…ˆï¼ˆReuters/Bloombergï¼‰+ Finnhub 48h + æœç´¢å›é€€ |
| **TechnicalAgent** | æŠ€æœ¯åˆ†æå¸ˆ | Kçº¿å½¢æ€ã€æŒ‡æ ‡èƒŒç¦» (MACD/RSI) | ç»“åˆå›¾è¡¨æ•°æ®ï¼Œç»™å‡ºä¹°å–ç‚¹ä½ |
| **FundamentalAgent** | ç ”ç©¶å‘˜ | è´¢æŠ¥è§£è¯»ã€ä¼°å€¼æ¨¡å‹ (DCF/PE) | å¤„ç†é•¿æ–‡æœ¬ï¼Œæ•°æ®æ¥æºäº 10-K/10-Q |
| **RiskAgent** ğŸ†• | é£æ§å®˜ | ä»“ä½ç®¡ç†ã€VaRè®¡ç®—ã€æ­¢æŸå»ºè®® | **ä¸ªæ€§åŒ–**ï¼ŒåŸºäºç”¨æˆ·é£é™©åå¥½ (Phase 3) |
| **MacroAgent** | å®è§‚åˆ†æå¸ˆ | å®è§‚ç»æµæ•°æ®ã€FRED API | å®æ—¶ CPI/GDP/åˆ©ç‡/å¤±ä¸šç‡ (Phase 2 å‡çº§) |

### 2.2 é¦–å¸­æŠ•èµ„å®˜ (ForumHost)

**ForumHost** æ˜¯æ•´ä¸ªç³»ç»Ÿçš„"å¤§è„‘"ï¼Œå®ƒä¸å†æ˜¯ç®€å•çš„æ‹¼æ¥å™¨ï¼Œè€Œæ˜¯å…·å¤‡**å†²çªæ¶ˆè§£**èƒ½åŠ›çš„å†³ç­–è€…ã€‚

*   **è¾“å…¥**ï¼šå„ Agent çš„ `AgentOutput`ï¼ˆå«ç½®ä¿¡åº¦ã€è¯æ®ï¼‰ã€‚
*   **å¤„ç†**ï¼š
    1.  **å†²çªæ£€æµ‹**ï¼šNews è¯´åˆ©å¥½ï¼ŒTech è¯´è¶…ä¹°ï¼Ÿ-> è¯†åˆ«åˆ†æ­§ç‚¹ã€‚
    2.  **è§‚ç‚¹èåˆ**ï¼šåŸºäºæƒé‡ï¼ˆå¦‚åŸºæœ¬é¢ > æŠ€æœ¯é¢ï¼‰ç”Ÿæˆæœ€ç»ˆåˆ¤æ–­ã€‚
    3.  **ä¸ªæ€§åŒ–æ³¨å…¥**ï¼šè¯»å– `UserContext`ï¼Œè°ƒæ•´å»ºè®®è¯­æ°”ï¼ˆæ¿€è¿› vs ä¿å®ˆï¼‰ã€‚
*   **è¾“å‡º**ï¼šç»“æ„åŒ–çš„ `ReportIR`ï¼ˆä¸­é—´è¡¨ç¤ºï¼‰ã€‚

---

## ä¸‰ã€å…³é”®æœºåˆ¶è¯¦è§£

### 3.1 åæ€å¾ªç¯ (Reflection Loop)

NewsAgent å’Œ DeepSearchAgent æ‹¥æœ‰è‡ªæˆ‘ä¿®æ­£èƒ½åŠ›ï¼š

```mermaid
sequenceDiagram
    participant A as Agent
    participant LLM
    participant Tool

    A->>Tool: 1. åˆå§‹å®½æ³›æœç´¢
    Tool-->>A: è¿”å›æµ·é‡æ‚ä¹±ä¿¡æ¯

    loop Reflection (Max 2 rounds)
        A->>LLM: 2. æ€»ç»“å¹¶è¯†åˆ«"çŸ¥è¯†ç©ºç™½"(Gaps)
        LLM-->>A: "ç¼ºå°‘å…·ä½“å‘å¸ƒæ—¥æœŸ" / "ç¼ºå°‘ç«å“å¯¹æ¯”"

        opt æœ‰ç©ºç™½
            A->>Tool: 3. é’ˆå¯¹æ€§ç²¾ç‚¼æœç´¢ (Targeted Search)
            Tool-->>A: è¡¥å……ç»†èŠ‚
            A->>A: 4. æ›´æ–°æ€»ç»“
        end
    end

    A->>Output: ç”Ÿæˆæœ€ç»ˆ AgentOutput
```

### 3.2 æ™ºèƒ½åˆä¼™äººè®°å¿† (UserContext)

ç³»ç»Ÿä¸å†æ˜¯"é˜…åå³ç„š"çš„èŠå¤©æœºå™¨äººï¼Œè€Œæ˜¯æœ‰è®°å¿†çš„ä¼™ä¼´ã€‚

*   **é™æ€ç”»åƒ**ï¼šé£é™©ç­‰çº§ (Conservative/Aggressive)ã€èµ„é‡‘ä½“é‡ã€æŠ•èµ„ç›®æ ‡ã€‚
*   **åŠ¨æ€å…³æ³¨**ï¼šWatchlistï¼ˆè‡ªé€‰è‚¡ï¼‰ã€æŒä»“æˆæœ¬ã€‚
*   **äº¤äº’å†å²**ï¼šè®°ä½ç”¨æˆ·åå¥½çš„è¡Œä¸šï¼ˆ"ä»–å–œæ¬¢ç§‘æŠ€è‚¡"ï¼‰ã€‚

### 3.3 çŸ¥è¯†æ£€ç´¢å¢å¼º (RAG - Phase 2) ğŸ†•

ç³»ç»Ÿå¼•å…¥å‘é‡æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰èƒ½åŠ›ï¼Œæ”¯æŒé•¿æ–‡æ¡£åˆ†æå’ŒçŸ¥è¯†åº“æ„å»ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAGEngine                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ chunk_text  â”‚ -> â”‚   ingest    â”‚ -> â”‚   query     â”‚ â”‚
â”‚  â”‚ (åˆ‡ç‰‡+è¾¹ç•Œ) â”‚    â”‚ (å‘é‡åŒ–å…¥åº“)â”‚    â”‚ (ç›¸ä¼¼åº¦æ£€ç´¢)â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚                            â”‚
â”‚                            v                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚ VectorStore â”‚                      â”‚
â”‚                    â”‚ (ChromaDB)  â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **VectorStore**: ChromaDB å°è£…ï¼Œæ”¯æŒæŒä¹…åŒ–å’Œä¸´æ—¶é›†åˆ
- **RAGEngine**: æ–‡æ¡£åˆ‡ç‰‡ï¼ˆå¥å­è¾¹ç•Œæ£€æµ‹ï¼‰+ å‘é‡åŒ–å…¥åº“ + ç›¸ä¼¼åº¦æ£€ç´¢
- **Embedding**: `paraphrase-multilingual-MiniLM-L12-v2` å¤šè¯­è¨€æ¨¡å‹

**åº”ç”¨åœºæ™¯**ï¼š
- DeepSearchAgent é•¿æ–‡ç ”æŠ¥åˆ†æ
- ç”¨æˆ·è®°å¿†æŒä¹…åŒ–å­˜å‚¨
- å†å²å¯¹è¯ä¸Šä¸‹æ–‡æ£€ç´¢

### 3.4 ä¸»åŠ¨æœåŠ¡ (Active Service)

ä» Request-Response è½¬å˜ä¸º Event-Drivenï¼š

*   **åœºæ™¯**ï¼šç”¨æˆ·æ²¡æ‰“å¼€ Appï¼Œä½†æŒä»“è‚¡è´¢æŠ¥çªå‘æš´é›·ã€‚
*   **æµç¨‹**ï¼š`AlertSystem` è½®è¯¢ -> è§¦å‘ `RiskAgent` è¯„ä¼° -> è°ƒç”¨ `Notification` æ¥å£ -> æ¨é€"ç´§æ€¥é£é™©æç¤º"ã€‚

---

## å››ã€æ•°æ®æµä¸ä¸­é—´è¡¨ç¤º (IR)

ä¸ºäº†è§£è€¦ç”Ÿæˆä¸æ¸²æŸ“ï¼Œæˆ‘ä»¬å®šä¹‰äº† **ReportIR (Intermediate Representation)**ã€‚

```json
{
  "ticker": "AAPL",
  "user_context": {"risk_profile": "balanced"},
  "overall_sentiment": "bullish",
  "confidence_score": 0.85,
  "sections": [
    {
      "type": "consensus",
      "content": "å„æ–¹ä¸€è‡´çœ‹å¥½ AI æ‰‹æœºæ¢æœºæ½®...",
      "sources": ["NewsAgent", "FundamentalAgent"]
    },
    {
      "type": "conflict",
      "content": "æŠ€æœ¯é¢æ˜¾ç¤ºçŸ­æœŸè¶…ä¹°ï¼Œä½†åŸºæœ¬é¢ä¼°å€¼ä»åˆç†",
      "agents": ["TechnicalAgent", "FundamentalAgent"]
    }
  ],
  "citations": [
    {
      "source_id": "DS-1",
      "title": "Apple earnings transcript",
      "url": "https://example.com",
      "snippet": "Management highlighted AI-driven demand...",
      "published_date": "2026-01-20",
      "confidence": 0.86,
      "freshness_hours": 6.5
    }
  ],
  "actionable_advice": "å»ºè®®åˆ†æ‰¹å»ºä»“ï¼Œå›è°ƒè‡³ 200 æ—¥å‡çº¿æ—¶åŠ ä»“",
  "risks": ["åå„æ–­è¯‰è®¼", "æ¶ˆè´¹ç”µå­å‘¨æœŸä¸‹è¡Œ"]
}
```

---

## äº”ã€æŠ€æœ¯æ ˆå‡çº§

| å±‚çº§ | åŸæœ‰æ–¹æ¡ˆ | **å‡çº§æ–¹æ¡ˆ** |
|------|----------|--------------|
| **ç¼–æ’** | LangChain Agent | **LangGraph** (æ”¯æŒå¾ªç¯ä¸å¤šåˆ†æ”¯) |
| **æœç´¢** | DuckDuckGo | **Tavily / Exa** (ä¸“ä¸šç ”æŠ¥æœç´¢) |
| **ç¼“å­˜** | å†…å­˜ Dict | **Redis / SQLite** (æŒä¹…åŒ– KV) |
| **ç›‘æ§** | Printæ—¥å¿— | **LangSmith** (å…¨é“¾è·¯ Tracing) |
| **é£æ§** | æ—  | **VaR / MaxDrawdown è®¡ç®—å¼•æ“** |
| **å‘é‡å­˜å‚¨** ğŸ†• | æ—  | **ChromaDB** (æŒä¹…åŒ–å‘é‡æ•°æ®åº“) |
| **Embedding** ğŸ†• | æ—  | **Sentence Transformers** (å¤šè¯­è¨€æœ¬åœ°æ¨¡å‹) |
| **å®è§‚æ•°æ®** ğŸ†• | æ—  | **FRED API** (ç¾è”å‚¨ç»æµæ•°æ®) |

---

> ğŸš€ **Next Step**: è¿›å…¥ Phase 2 ç ”æŠ¥å¢å¼ºï¼ˆReportIR Schema/DeepSearch/Macroï¼‰ä¸å‰ç«¯æŠ¥å‘Šå¡ç‰‡å¯¹é½ã€‚
