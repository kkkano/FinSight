# FinSight 对话场景测试文档

> 创建日期: 2025-12-27
> 目的: 定义各种对话场景的预期行为，确保 Agent 提供良好的用户体验

---

## 一、意图分类与处理器映射

| 意图 | 触发关键词 | 处理器 | 预期响应时间 | 工具调用数 |
|------|-----------|--------|-------------|-----------|
| **GREETING** | 你好、hi、hello、你是谁 | `_handle_greeting` | <1秒 | 0 |
| **CHAT** | 股价、价格、多少钱、走势 | `ChatHandler` | 2-5秒 | 1-2 |
| **REPORT** | 分析、报告、值得投资吗 | `LangGraph Agent` | 15-60秒 | 5-10 |
| **FOLLOWUP** | 为什么、详细说说、风险呢 | `FollowupHandler` | 2-5秒 | 0-2 |
| **ALERT** | 提醒、监控、跌破 | `_handle_alert` | <1秒 | 0 |
| **CLARIFY** | 无法识别/非金融问题 | `_handle_clarify` | <1秒 | 0 |

---

## 二、对话场景测试用例

### 场景 1: 简单问候
```
用户: 你好
预期意图: GREETING
预期响应: "您好！我是 FinSight AI 金融助手..."
工具调用: 无
响应时间: <1秒
```

### 场景 2: 简单价格查询
```
用户: AAPL 现在多少钱
预期意图: CHAT
预期响应: "AAPL 当前价格: $XXX.XX | 变动: +X.XX (+X.XX%)"
工具调用: get_stock_price (1次)
响应时间: 2-5秒
```

### 场景 3: 股价走势查询
```
用户: AAPL 股价走势
预期意图: CHAT
预期响应: 简短的价格信息 + 图表标记 [CHART:AAPL:line]
工具调用: get_stock_price (1次)
响应时间: 2-5秒
```

### 场景 4: 深度分析报告
```
用户: 帮我分析一下苹果公司，生成投资报告
预期意图: REPORT
预期响应: 800+ 字的专业分析报告
工具调用: 5-10次 (datetime, search, price, news, sentiment, etc.)
响应时间: 15-60秒
```

### 场景 5: 投资建议
```
用户: 现在买英伟达怎么样
预期意图: REPORT (包含"值得买"类关键词)
预期响应: 专业分析 + 投资建议
工具调用: 5-10次
响应时间: 15-60秒
```

### 场景 6: 追问上文
```
用户: 风险在哪？
预期意图: FOLLOWUP
预期响应: 基于上下文的风险分析
工具调用: 0-2次
响应时间: 2-5秒
```

### 场景 7: 对比查询
```
用户: 纳斯达克和标普500有什么区别
预期意图: CHAT
预期响应: 简洁的对比分析
工具调用: 1-2次
响应时间: 3-8秒
```

### 场景 8: 新闻查询
```
用户: 特斯拉最近有什么新闻
预期意图: CHAT
预期响应: 最近的新闻摘要
工具调用: get_company_news (1次)
响应时间: 2-5秒
```

### 场景 9: 非金融问题
```
用户: 帮我写一个冒泡排序
预期意图: CLARIFY
预期响应: "抱歉，我是专注于金融市场分析的助手..."
工具调用: 无
响应时间: <1秒
```

### 场景 10: 监控请求
```
用户: 当 AAPL 跌破 250 美元时提醒我
预期意图: ALERT
预期响应: 监控功能说明（功能开发中）
工具调用: 无
响应时间: <1秒
```

---

## 三、问题修复记录

### 2025-12-27 修复: /chat/stream 端点绕过意图路由

**问题**: 所有查询都直接调用 LangGraph Agent，导致简单问题也生成完整报告

**原因**: `/chat/stream` 端点直接调用 `report_agent.analyze_stream()`，完全绕过了意图路由

**修复**:
1. 在 `/chat/stream` 端点中先进行意图路由
2. 只有 `Intent.REPORT` 才使用 LangGraph Agent
3. 其他意图使用 `agent.chat()` 快速响应

**修复后行为**:
- GREETING/CHAT/FOLLOWUP/ALERT/CLARIFY → 快速响应 (2-5秒)
- REPORT → LangGraph Agent 流式输出 (15-60秒)

---

## 四、用户体验优化建议

1. **响应速度**: 简单查询应在 5 秒内响应
2. **渐进式输出**: 复杂查询应显示进度提示
3. **错误处理**: 数据源失败时应有友好提示
4. **上下文记忆**: 支持多轮对话，记住用户关注的股票
5. **图表联动**: 价格查询自动显示相关图表

---

## 五、测试命令

```bash
# 启动后端
python -m uvicorn backend.api.main:app --host 0.0.0.0 --port 8000 --reload

# 测试简单查询 (应该快速响应)
curl -X POST http://localhost:8000/chat/stream \
  -H "Content-Type: application/json" \
  -d '{"query": "AAPL 现在多少钱"}'

# 测试深度报告 (应该调用多个工具)
curl -X POST http://localhost:8000/chat/stream \
  -H "Content-Type: application/json" \
  -d '{"query": "帮我分析一下苹果公司"}'
```
