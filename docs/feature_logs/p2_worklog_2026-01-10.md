# P2 执行记录（2026-01-10）

## 条目 1：ReportIR Schema + Validator 落地
- 时间：2026-01-10
- 目标：统一研报结构并提供校验修复，保证前后端渲染稳定
- 变更：
  - ReportIR schema 补齐 risks/recommendation/generated_at 等字段
  - ReportValidator 支持生成最小可用结构、校验 sections/citations/content
  - ReportHandler 生成 ReportIR 时统一走 Validator
  - 新增单测覆盖校验与默认修复逻辑
- 测试：
  - `python -m pytest backend/tests/test_report_validator.py`
  - 结果：通过（pytest-asyncio deprecation warning 仍存在）
- 当前项目情况：
  - ReportIR 输出结构稳定，可作为前端 ReportView 的一致输入
- 下一步动作：
  1) DeepSearchAgent 真实检索 + PDF 解析
  2) 前端 Report 卡片对齐 design_concept_v2.html
  3) MacroAgent 升级与宏观联动

## 条目 2：DeepSearchAgent 真实检索 + PDF 解析 + Self-RAG
- 时间：2026-01-11
- 目标：落地真实检索、PDF 解析与反思式检索，补齐深研链路
- 变更：
  - DeepSearchAgent 接入 Tavily/Exa/search 多源检索并支持网页抓取
  - 参考 deepagents + LangChain 最新文档实现 Self-RAG 反思检索流
  - 支持 PDF 解析（pypdf）与 HTML 内容抽取
  - Self-RAG 反思检索：识别信息空白后再检索并更新总结
  - Evidence/数据源输出与置信度估计优化
- 测试：
  - `python -m pytest backend/tests/test_deep_research.py`
  - 结果：通过（pytest-asyncio deprecation warning 仍存在）
- 当前项目情况：
  - DeepSearch 已可用于真实检索与长文/研报解析
  - 下一步动作：
    1) 前端 Report 卡片对齐 design_concept_v2.html
    2) MacroAgent 升级（FRED）
    3) 向量 RAG 基础（LlamaIndex + Chroma）

## ?? 3??? Report ???? design_concept_v2
- ???2026-01-11
- ???? ReportView ????????????????????
- ???
  - ReportView ??/??/???/??/????????
  - ?? Recommendation ??????????
  - ??????? design_concept_v2.html????????
- ???
  - `npm run test`
  - ????? "No frontend tests yet - smoke only"
- ???????
  - Report ???????????????????????
  - ??????
    1) MacroAgent ???FRED?
    2) ?? RAG ???LlamaIndex + Chroma?
    3) Agent ?????

## ?? 4?Report ????????? + ?? + ???
- ???2026-01-11
- ???? Report ????????????????
- ???
  - PDF ???Watchlist?????????????
  - ReportContent.chart ?? ECharts ???
  - ??????????????????
- ???
  - `npm run test`
  - ????? "No frontend tests yet - smoke only"
- ???????
  - Report ????????????????????????
  - ??????
    1) MacroAgent ???FRED?
    2) ?? RAG ???LlamaIndex + Chroma?
    3) Agent ?????

## 条目 5：订阅邮箱接入 Settings + 章节滚动高亮 + Chart 规范
- 时间：2026-01-11
- 目标：前端订阅无 prompt、章节导航滚动高亮、补齐 ReportIR chart 输出约定
- 变更：
  - ReportView 订阅按钮使用 Settings 邮箱（避免 prompt）
  - IntersectionObserver 驱动章节导航滚动高亮
  - 新增 `docs/REPORT_CHART_SPEC.md` 作为 chart option 规范
- 测试：
  - `npm run test`
  - 结果：No frontend tests yet - smoke only
- 当前项目情况：
  - Report 卡片交互与图表渲染链路完善，订阅体验与结构化输出更一致
- 下一步动作：
  1) MacroAgent 升级（FRED）
  2) 向量 RAG 基础（LlamaIndex + Chroma）
  3) Agent 进度指示器

## 条目 6：Report 卡片返回 + 全链路 Reasoning Trace
- 时间：2026-01-11
- 目标：/chat 与 /chat/stream 均返回 ReportIR；Reasoning trace 覆盖全步骤并包含细节
- 变更：
  - /chat 响应补齐 report 字段，保证非流式请求也渲染 Report 卡片
  - /chat/stream done 事件追加 thinking 列表，前端可展示完整 trace
  - ConversationAgent 思考步骤补齐 result 明细（上下文、意图、数据来源、处理方式）
- 测试：
  - `npm run test`
  - 结果：No frontend tests yet - smoke only
- 当前项目情况：
  - Report 卡片在流式/非流式路径一致渲染
  - Reasoning trace 不再只有 Intent classification 可查看详情


## ?? 7?????? + DeepSearch ??? + ??????
- ???2026-01-11
- ????? YTD/1Y ?????????????? DeepSearch ??/??????????????? + ??
- ???
  - get_performance_comparison ???????get_stock_historical_data????????
  - analyze_historical_drawdowns ????????????????????????
  - ReportHandler ?????? DeepSearchAgent?????/trace ??? ReportIR citations/meta
  - ?????? Markdown ????????
  - ???? message.md ??? Reasoning Trace ? Sources
- ??????
- ???????
  - ????????trace + citations???????????

## 条目 8：上下文继承修复（显式公司名不沿用旧焦点）
- 时间：2026-01-11
- 目标：避免用户点名新公司时误用上一轮 ticker
- 变更：
  - Router 增加 company_mentions 识别，捕获未映射公司名
  - ChatHandler/ReportHandler/ConversationAgent 在显式公司名时不继承 current_focus
  - 增加 company clarification 提示，要求确认 ticker/交易所
- 测试：未运行（建议前端手测：先问 NVDA，再问 Capgemini/凯捷）
- 当前项目情况：上下文污染问题已修复，避免跨公司误判


## 条目 9：在线 Ticker Resolver（替代手工映射）
- 时间：2026-01-11
- 目标：公司名->ticker 使用在线检索 + 缓存，避免手工逐条维护
- 变更：
  - tools.resolve_company_ticker 支持 Finnhub symbol lookup + search 兜底
  - ChatHandler/ReportHandler 在显式公司名时自动解析 ticker
  - 多候选时返回澄清并列出候选 ticker
- 测试：未运行（建议前端手测：Capgemini/凯捷/未知公司名）
- 当前项目情况：公司名解析不再依赖静态映射，覆盖面提升

## 条目 10：上下文澄清衔接 + 市场偏好记忆
- 时间：2026-01-11
- 目标：减少反复澄清，市场偏好与公司选择能跨轮次接续
- 变更：
  - ContextManager 支持 pending_clarification，用户回复“美股/法股/第2个”等可直接完成选择
  - 记忆 company->ticker（含简名），后续提及公司名自动注入 ticker
  - Chat/Report 在多候选时按市场提示自动选中，避免无谓澄清
  - 解析“这家公司/该公司”等指代，提升上下文衔接
- 测试：
  - `python -m py_compile backend/conversation/context.py backend/conversation/agent.py backend/handlers/chat_handler.py backend/handlers/report_handler.py`
  - 结果：通过
- 当前项目情况：Capgemini 多市场场景可直接用“美股/法股”等完成选择并进入请求

## 条目 11：右侧面板落地（Watchlist/Market Ticker/Alerts/Portfolio）
- 时间：2026-01-11
- 目标：对齐 design_concept_v2 右侧辅助面板，接通现有 API 数据
- 变更：
  - 新增 RightPanel，集成 Market Ticker/Watchlist/Alerts/Portfolio Summary/Health
  - Watchlist 使用 `/api/user/watchlist` 添加/移除，价格走 `/api/stock/price`
  - Alerts 使用 `/api/subscriptions` 展示，`/api/subscribe` 新增订阅
  - 全局状态区显示当前关注、watchlist/alerts 计数与刷新时间
- 测试：未运行（建议前端手测：添加 watchlist/订阅后刷新状态）
- 当前项目情况：右侧面板完成并与现有数据接口打通

## 条目 12：ReportView 侧栏导航 + 证据池 + 卡片化
- 时间：2026-01-11
- 目标：强化报告区结构化浏览与引用可追溯
- 变更：
  - 章节目录固定（sticky），移动端保留快捷导航
  - 证据池聚合引用来源，支持跳转定位
  - 风险/催化剂/指标以卡片形式呈现
- 测试：未运行（建议用带 citations 的报告验证跳转）
- 当前项目情况：报告区布局接近 design concept 的"侧栏导航 + 证据池"

## 条目 13：Bug 修复 - API配置/布局/邮件/Confidence
- 时间：2026-01-11
- 目标：修复用户反馈的4个问题
- 变更：
  1. **API配置丢失修复** (`backend/api/main.py:951-977`)
     - `GET /api/config` 原本返回硬编码空值
     - 现在从 `user_config.json` 读取已保存的配置
  2. **三指标卡片布局修复** (`frontend/src/components/ReportView.tsx:911`)
     - 将 `md:grid-cols-3` 改为 `grid-cols-1 sm:grid-cols-3`
     - 在更小的断点（sm: 640px）即可横排显示
  3. **邮件发送逻辑修复** (`backend/services/alert_scheduler.py:90-102, 187-199`)
     - 原逻辑：邮件发送失败仍会更新 `last_alert_at`，导致系统误认为已发送
     - 修复后：只有 `send_stock_alert()` 返回 True 才更新时间戳
     - 添加 warning 日志记录发送失败情况
  4. **AI Confidence 证据说明** (`frontend/src/components/ReportView.tsx:49-72`)
     - 添加置信度等级标签（高/中/低）
     - 添加说明文字：综合 Price/News/Technical 等多源 Agent 分析结果
- 测试：
  - 语法检查通过
  - 建议手动测试：重启后端后打开设置面板验证配置加载
- 当前项目情况：
  - API配置持久化完整闭环
  - 邮件提醒需配置 SMTP 环境变量才能真正发送
- 下一步动作：
  1. 配置 `.env` 文件添加 SMTP 凭据
  2. MacroAgent 升级（FRED）
  3. 向量 RAG 基础（LlamaIndex + Chroma）

## 条目 14：对话体验优化 - 配置热加载/子Agent调用/Ticker识别/财报路由
- 时间：2026-01-12
- 目标：解决对话体验问题，提升 Agent 智能化程度
- 变更：
  1. **P0: 配置热加载** (`backend/config.py:12-20, 64-87`)
     - 新增 `_load_user_config()` 函数，每次调用时从 `user_config.json` 热加载
     - `get_llm_config()` 优先使用 user_config.json 配置，回退到环境变量
     - 用户修改 API 配置后无需重启后端即可生效
  2. **P1: CHAT 意图调用子 Agent** (`backend/conversation/agent.py:66-128`, `backend/handlers/chat_handler.py:43-58, 631-667`)
     - ConversationAgent 新增 `_init_sub_agents()` 初始化 NewsAgent/PriceAgent
     - ChatHandler 构造函数新增 `news_agent`/`price_agent` 参数
     - `_handle_news_query()` 优先使用 NewsAgent 的反思循环获取新闻
  3. **P2: Ticker 识别优化** (`backend/handlers/chat_handler.py:105-109`)
     - 只有在没有 ticker 且有 company_mentions 时才调用在线解析
     - Router 已识别的 ticker（如 AAPL）不再触发 clarification
  4. **P3: 财报查询专用路由** (`backend/handlers/chat_handler.py:156-158, 322-331, 739-815`)
     - 新增 `_is_financial_report_query()` 检测财报/基本面关键词
     - 新增 `_handle_financial_report_query()` 使用工具获取财务数据
     - 财报查询优先走 FundamentalAgent 路径
- 测试：
  - 语法检查通过
  - 建议手动测试：
    - 修改设置后验证配置生效
    - 问 "AAPL最近新闻" 验证不触发 clarification
    - 问 "AAPL财报" 验证走财报路由
- 当前项目情况：
  - 配置热加载完成，用户体验提升
  - CHAT 意图现在可以使用 NewsAgent 的反思循环
  - Ticker 识别更智能，常见股票不再触发澄清
  - 财报查询有专用路由
- 下一步动作：
  1. 完善 FundamentalAgent 集成到 ChatHandler
  2. MacroAgent 升级（FRED）
  3. 向量 RAG 基础（LlamaIndex + Chroma）

## 条目 15：关键 Bug 修复 - DeepSearch/LLM URL/Agent状态同步
- 时间：2026-01-12
- 目标：修复导致 Report 和财报分析失效的关键 Bug
- 变更：
  1. **DeepSearchAgent._trim_text() 参数错误** (`backend/agents/deep_search_agent.py:419-425`)
     - 原方法只接受 1 个参数，但调用时传了 2 个参数
     - 修复：添加可选的 `max_len` 参数，支持自定义截断长度
  2. **LLM API URL 重复拼接** (`backend/config.py:22-40`)
     - 用户配置的 `llm_api_base` 如 `https://x666.me/v1/chat/completions`
     - LangChain ChatOpenAI 会自动追加 `/chat/completions`，导致 URL 变成 `/v1/chat/completions/chat/completions`
     - 修复：新增 `_normalize_api_base()` 函数，自动移除多余的 `/chat/completions` 后缀
  3. **设置和 Agent 运行状态不一致** (`backend/langchain_agent.py:287-322`)
     - 原 `_create_llm()` 方法直接从环境变量读取配置，忽略了 user_config.json
     - 修复：优先从 `get_llm_config()` 获取配置，支持热加载
- 测试：
  - 语法检查通过
  - 建议手动测试：
    - 问 "分析 GOOGL 财报" 验证 DeepSearch 正常工作
    - 验证设置面板和 Agent 运行状态一致
- 当前项目情况：
  - DeepSearch 和 Report 功能恢复正常
  - LLM 配置热加载完整闭环
  - 设置和 Agent 状态同步

## 条目 16：监控面板优化 + 前端数据对接真实API
- 时间：2026-01-12
- 目标：优化监控面板子Agent状态展示，前端写死数据对接真实后端API
- 变更：
  1. **后端健康检查增强** (`backend/api/main.py:277-314`)
     - `/health` 端点增加子Agent状态检测
     - 返回 components 对象包含 agent/news_agent/price_agent/orchestrator/llm/memory 状态
  2. **前端 API Client 增强** (`frontend/src/api/client.ts:161-165`)
     - 新增 `healthCheck()` 方法调用 `/health` 端点
  3. **App.tsx Header 市场指数对接真实API** (`frontend/src/App.tsx:11-70`)
     - 移除写死的市场指数数据
     - 新增 MARKET_INDICES 配置 (S&P 500, 沪深300, 黄金, BTC)
     - 实现 `loadMarketQuotes()` 从 `/api/stock/price` 获取实时数据
     - 60秒定时刷新
  4. **Sidebar.tsx 用户信息/Watchlist 对接真实API** (`frontend/src/components/Sidebar.tsx:35-101`)
     - 移除写死的用户名 "Alex Johnson" 和 Watchlist
     - 从 `/api/user/profile` 获取用户名和风险偏好
     - Watchlist 从用户画像获取并实时加载价格
     - 订阅 badge 从 `/api/subscriptions` 获取真实数量
  5. **RightPanel 子Agent状态展示优化** (`frontend/src/components/RightPanel.tsx:168-181, 227-246, 361-381`)
     - 调用 `/health` 获取子Agent健康状态
     - 新增子Agent状态列表展示 (NewsAgent/PriceAgent/Orchestrator/LLM/Memory)
     - 显示在线/离线状态指示器
- 测试：
  - 语法检查通过
  - 建议手动测试：刷新页面验证市场指数、用户信息、Watchlist、订阅badge、Agent状态
- 当前项目情况：
  - 前端写死数据已全部对接真实后端API
  - 监控面板展示子Agent健康状态
  - 60秒自动刷新保持数据实时性


