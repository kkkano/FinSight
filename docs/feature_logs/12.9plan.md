# FinSight Ã— BettaFish å¤šAgentå‡çº§ç»ˆææ‰§è¡Œè®¡åˆ’ï¼ˆ2025-12-09ï¼‰

æœ¬æ–‡æ¡£æ˜¯ FinSight é¡¹ç›®å¯¹é½ BettaFish æ¶æ„çš„å”¯ä¸€æ‰§è¡Œä¾æ®ã€‚å…¶ä»–ç›¸å…³æ–‡æ¡£ï¼ˆBettaFish_Alignment_Plan_CN.mdã€FinSight_BettaFish_Final_Plan_2025-12-08.mdã€feature_logs/opus.mdï¼‰å½’æ¡£ä¸ºæŠ€æœ¯å‚è€ƒï¼Œä¸å†å•ç‹¬ç»´æŠ¤ã€‚

---

## ä¸€ã€BettaFish æ ¸å¿ƒæœºåˆ¶é€Ÿè§ˆï¼ˆå¿…é¡»ç†è§£ï¼‰

### 1.1 è®ºå›å¼å¤šAgentåä½œ
- **å››ä¸ªä¸“èŒAgent**ï¼šQueryAgentï¼ˆæ–°é—»æœç´¢ï¼‰ã€MediaAgentï¼ˆå¤šæ¨¡æ€ï¼‰ã€InsightAgentï¼ˆå†å²èˆ†æƒ…ï¼‰ã€ReportAgentï¼ˆæŠ¥å‘Šæ•´åˆï¼‰
- **ForumEngine**ï¼šä¸­å¤®è®ºå›ï¼ŒAgentä¸ç›´æ¥é€šä¿¡ï¼Œé€šè¿‡forum.logå¼‚æ­¥äº¤æµ
- **ForumHost**ï¼šç‹¬ç«‹LLMä¸»æŒäººï¼Œè¾“å‡ºå››æ®µå¼å¼•å¯¼ï¼ˆäº‹ä»¶æ—¶é—´çº¿â†’è§‚ç‚¹æ•´åˆâ†’æ·±åº¦åˆ†æâ†’è®¨è®ºæŒ‡å¼•ï¼‰

### 1.2 åæ€å¾ªç¯ï¼ˆReflection Loopï¼‰
æ¯ä¸ªAgentå†…éƒ¨ï¼šåˆå§‹æœç´¢ â†’ é¦–æ¬¡æ€»ç»“ â†’ [ReflectionNodeè¯†åˆ«çŸ¥è¯†ç©ºç™½ â†’ ç²¾ç‚¼æœç´¢ â†’ ReflectionSummaryNodeæ›´æ–°æ€»ç»“] Ã— 2-3è½®

### 1.3 é«˜å¬å›+KVç¼“å­˜
- å¤šæºå¹¶è¡Œæœç´¢ï¼ˆTavily+DDG+çˆ¬è™«ï¼‰
- LLMä»…åš2-5å¥æ‘˜è¦ï¼Œä¿ç•™Markdowné“¾æ¥
- ç»“æœå†™å…¥KVï¼ˆkey=ticker:fieldï¼Œå«as_of/source/text/links/ttlï¼‰

### 1.4 ä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰
æŠ¥å‘Šå…ˆç”Ÿæˆç»“æ„åŒ–JSONï¼ˆsections/evidence/confidence/risksï¼‰ï¼Œæ ¡éªŒåå†æ¸²æŸ“Markdown/HTML

---

## äºŒã€FinSightç›®æ ‡æ¶æ„

```
User â†’ Orchestrator(LangGraph)
       â”œâ”€â”€ PriceAgent        [å¸¸é©»] å®æ—¶è¡Œæƒ…ï¼ŒTTL=30ç§’
       â”œâ”€â”€ TechnicalAgent    [å¸¸é©»] æŠ€æœ¯æŒ‡æ ‡ï¼ŒTTL=5åˆ†é’Ÿ
       â”œâ”€â”€ FundamentalAgent  [å¸¸é©»] è´¢æŠ¥ä¼°å€¼ï¼ŒTTL=1å°æ—¶
       â”œâ”€â”€ NewsAgent         [å¸¸é©»] æ–°é—»èˆ†æƒ…ï¼ŒTTL=10åˆ†é’Ÿ
       â”œâ”€â”€ MacroAgent        [æŒ‰éœ€] å®è§‚äº‹ä»¶ï¼Œå¤æ‚é—®é¢˜è§¦å‘
       â””â”€â”€ DeepSearchAgent   [æŒ‰éœ€] é•¿æ–‡ç ”ç©¶ï¼Œä¿¡æ¯ä¸è¶³è§¦å‘
       â†’ ForumHostï¼ˆå†²çªæ¶ˆè§£+è§‚ç‚¹èåˆï¼‰
       â†’ IRæ ¡éªŒ â†’ ReportRendererï¼ˆMarkdown/HTML/PDFï¼‰
```

**å…±äº«å±‚ï¼š**
- KVç¼“å­˜ï¼š`backend/services/cache.py`
- ç†”æ–­å™¨ï¼š`backend/services/circuit_breaker.py`
- è¯Šæ–­æ—¥å¿—ï¼šsource/duration_ms/fail_reason/fallback_used/cache_hit

---

## ä¸‰ã€ä¸‰é˜¶æ®µæ‰§è¡Œè®¡åˆ’

### é˜¶æ®µ0ï¼šåŸºåº§å¼ºåŒ–ï¼ˆç¬¬1-2å‘¨ï¼‰

#### Day 1-2ï¼šå·¥å…·è¾“å‡ºæ ‡å‡†åŒ–
**æ–‡ä»¶ï¼š** `tools.py`

**æ”¹åŠ¨ï¼š** æ‰€æœ‰å·¥å…·å‡½æ•°è¿”å›ç»Ÿä¸€ç»“æ„
```python
{
    "value": ...,           # å®é™…æ•°æ®
    "as_of": "ISOæ—¶é—´æˆ³",    # æ•°æ®æ—¶é—´
    "source": "yfinance",   # æ•°æ®æ¥æº
    "fallback_used": false, # æ˜¯å¦ç”¨äº†å…œåº•
    "duration_ms": 230,     # è€—æ—¶æ¯«ç§’
    "fail_reason": null     # å¤±è´¥åŸå› ï¼ˆæˆåŠŸä¸ºnullï¼‰
}
```

**éªŒæ”¶ï¼š** è¿è¡Œ`test/test_tools.py`ï¼Œæ‰€æœ‰å·¥å…·è¾“å‡ºç¬¦åˆschema

---

#### Day 3-4ï¼šKVç¼“å­˜å±‚
**æ–°å»ºæ–‡ä»¶ï¼š** `backend/services/cache.py`

```python
class ToolCache:
    def __init__(self):
        self.cache = {}
    
    def get(self, key: str) -> Optional[dict]:
        if key in self.cache:
            data, timestamp, ttl = self.cache[key]
            if (datetime.now() - timestamp).seconds < ttl:
                return data
        return None
    
    def set(self, key: str, value: dict, ttl: int = 60):
        self.cache[key] = (value, datetime.now(), ttl)
    
    def make_key(self, ticker: str, field: str, interval: str = "1d") -> str:
        return f"{ticker}:{field}:{interval}"
```

**TTLé…ç½®ï¼š** è¡Œæƒ…30ç§’ã€æ–°é—»600ç§’ã€è´¢æŠ¥3600ç§’

**éªŒæ”¶ï¼š** è¿ç»­è°ƒç”¨`get_stock_price("AAPL")`ä¸¤æ¬¡ï¼Œç¬¬äºŒæ¬¡å‘½ä¸­ç¼“å­˜

---

#### Day 5-6ï¼šç†”æ–­å™¨
**æ–°å»ºæ–‡ä»¶ï¼š** `backend/services/circuit_breaker.py`

```python
class CircuitBreaker:
    # çŠ¶æ€ï¼šCLOSED(æ­£å¸¸) â†’ OPEN(ç†”æ–­) â†’ HALF_OPEN(è¯•æ¢)
    def __init__(self, failure_threshold=3, recovery_timeout=300):
        self.states = {}  # {source: {failures, last_failure, state}}
    
    def record_failure(self, source: str): ...
    def record_success(self, source: str): ...
    def can_call(self, source: str) -> bool: ...
```

**éªŒæ”¶ï¼š** yfinanceè¿ç»­å¤±è´¥3æ¬¡åè‡ªåŠ¨è·³è¿‡ï¼Œ5åˆ†é’Ÿåæ¢å¤

---

#### Day 7-8ï¼šæœç´¢å…œåº•
**æ–‡ä»¶ï¼š** `tools.py`

**æ”¹åŠ¨ï¼š** åœ¨`get_stock_price`ç­‰å‡½æ•°æœ«å°¾å¢åŠ Tavilyå…œåº•
```python
# æ‰€æœ‰æºéƒ½å¤±è´¥æ—¶
if all_failed and TAVILY_AVAILABLE:
    result = _search_price_fallback(ticker)  # é™æ—¶3ç§’
    result["fallback_used"] = True
    return result
```

**éªŒæ”¶ï¼š** æ¨¡æ‹Ÿæ‰€æœ‰APIå¤±è´¥ï¼Œä»èƒ½è¿”å›æœç´¢å…œåº•çš„ä»·æ ¼

---

#### Day 9-10ï¼šLangGraphæ‰“ç‚¹
**æ–‡ä»¶ï¼š** `langchain_agent.py`

**æ”¹åŠ¨ï¼š** æ¯ä¸ªèŠ‚ç‚¹å¢åŠ tracing metadata
```python
# åœ¨å·¥å…·è°ƒç”¨å‰åè®°å½•
with trace_tool(name="get_stock_price", ticker=ticker) as span:
    result = get_stock_price(ticker)
    span.set_attribute("source", result["source"])
    span.set_attribute("duration_ms", result["duration_ms"])
    span.set_attribute("cache_hit", result.get("cache_hit", False))
```

**éªŒæ”¶ï¼š** LangSmithå¯è§å®Œæ•´è°ƒç”¨é“¾ï¼Œæ¯ä¸ªå·¥å…·æœ‰source/durationæ ‡ç­¾

---

#### Day 11-12ï¼šå‰ç«¯è¯Šæ–­é¢æ¿
**æ–‡ä»¶ï¼š** `frontend/src/components/Diagnostics.tsx`ï¼ˆæ–°å»ºï¼‰

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºå·¥å…·è°ƒç”¨åˆ—è¡¨ï¼ˆåç§°ã€è€—æ—¶ã€çŠ¶æ€ï¼‰
- æ ‡è®°æ•°æ®æ¥æºï¼ˆAPI/ç¼“å­˜/å…œåº•ï¼‰
- å¤±è´¥åŸå› é«˜äº®æ˜¾ç¤º

**éªŒæ”¶ï¼š** å¯¹è¯æ—¶å¯å±•å¼€æŸ¥çœ‹è¯Šæ–­ä¿¡æ¯

---

#### Day 13-14ï¼šæµ‹è¯•+æ–‡æ¡£
**æ–°å¢æµ‹è¯•ï¼š**
- `test/test_cache.py` - ç¼“å­˜å‘½ä¸­/è¿‡æœŸ/æ¸…ç†
- `test/test_circuit_breaker.py` - ç†”æ–­/æ¢å¤çŠ¶æ€æœº
- `test/test_fallback.py` - å…¨æºå¤±è´¥â†’æœç´¢å…œåº•æˆåŠŸ

**æ–‡æ¡£ï¼š** æ›´æ–°æœ¬æ–‡ä»¶çš„"é˜¶æ®µ0å®Œæˆ"çŠ¶æ€

---

#### é˜¶æ®µ0éªŒæ”¶æ ‡å‡†ï¼š
- âœ… å·¥å…·å¤±è´¥ä¸å†500ï¼Œè¿”å›ç»“æ„åŒ–é”™è¯¯
- âœ… ç¼“å­˜å‘½ä¸­ç‡å¯è§‚æµ‹ï¼ˆæ—¥å¿—å¯è§cache_hitï¼‰
- âœ… ç†”æ–­çŠ¶æ€å¯è§ï¼ˆdiagnosticsæ˜¾ç¤ºè·³è¿‡åŸå› ï¼‰
- âœ… æœç´¢å…œåº•å¯ç”¨ï¼ˆTavilyé™æ—¶è¿”å›ï¼‰
- âœ… LangSmithå¯è§å®Œæ•´è°ƒç”¨é“¾

---

### é˜¶æ®µ1ï¼šå­Agenté›å½¢ï¼ˆç¬¬3-4å‘¨ï¼‰

#### Week 3ï¼šBaseAgent + NewsAgent + PriceAgent

**æ–°å»ºç›®å½•ï¼š** `backend/agents/`

##### `base_agent.py`
```python
from dataclasses import dataclass
from typing import List, Optional
from datetime import datetime

@dataclass
class EvidenceItem:
    text: str
    source: str
    url: Optional[str]
    timestamp: Optional[datetime]
    confidence: float  # 0-1

@dataclass
class AgentOutput:
    agent_name: str
    summary: str
    evidence: List[EvidenceItem]
    confidence: float
    data_sources: List[str]
    as_of: datetime
    fallback_used: bool
    risks: List[str]

class BaseFinancialAgent:
    AGENT_NAME = "base"
    MAX_REFLECTIONS = 2
    
    def __init__(self, llm, cache):
        self.llm = llm
        self.cache = cache
    
    async def research(self, query: str, ticker: str) -> AgentOutput:
        # 1. åˆå§‹æœç´¢
        results = await self._initial_search(query, ticker)
        summary = await self._first_summary(results)
        
        # 2. åæ€å¾ªç¯
        for i in range(self.MAX_REFLECTIONS):
            gaps = await self._identify_gaps(summary)
            if not gaps:
                break
            new_data = await self._targeted_search(gaps)
            summary = await self._update_summary(summary, new_data)
        
        return self._format_output(summary, results)
    
    async def _identify_gaps(self, summary: str) -> List[str]:
        """LLMè¯†åˆ«çŸ¥è¯†ç©ºç™½"""
        prompt = f"""åˆ†æä»¥ä¸‹æ€»ç»“ï¼Œè¯†åˆ«ä¿¡æ¯ç©ºç™½ï¼š
        {summary}
        
        æ£€æŸ¥ï¼šç¼ºå°‘æ—¶é—´çº¿ï¼Ÿç¼ºå°‘æ•°å€¼ï¼Ÿç¼ºå°‘å¯¹æ¯”ï¼Ÿç¼ºå°‘é£é™©ï¼Ÿ
        è¾“å‡ºéœ€è¦è¡¥å……çš„é—®é¢˜åˆ—è¡¨ï¼Œä¿¡æ¯å……è¶³åˆ™è¾“å‡ºç©ºåˆ—è¡¨ã€‚"""
        return await self.llm.generate(prompt)
```

##### `news_agent.py`
```python
class NewsAgent(BaseFinancialAgent):
    AGENT_NAME = "NewsAgent"
    CACHE_TTL = 600
    
    async def _initial_search(self, query: str, ticker: str):
        cache_key = f"{ticker}:news:24h"
        cached = self.cache.get(cache_key)
        if cached:
            return cached
        
        results = []
        # Finnhubæ–°é—»
        results.extend(await self._fetch_finnhub(ticker))
        # Tavilyæœç´¢
        results.extend(await self._fetch_tavily(f"{ticker} stock news"))
        
        results = self._deduplicate(results)
        self.cache.set(cache_key, results, self.CACHE_TTL)
        return results
```

##### `price_agent.py`
```python
class PriceAgent(BaseFinancialAgent):
    AGENT_NAME = "PriceAgent"
    CACHE_TTL = 30
    MAX_REFLECTIONS = 0  # è¡Œæƒ…ä¸éœ€è¦åæ€
    
    async def _initial_search(self, query: str, ticker: str):
        cache_key = f"{ticker}:price:realtime"
        cached = self.cache.get(cache_key)
        if cached:
            return cached
        
        # å¤šæºå›é€€
        for source in ["yfinance", "alphavantage", "finnhub", "tavily"]:
            if self.circuit_breaker.can_call(source):
                try:
                    result = await self._fetch_from(source, ticker)
                    self.circuit_breaker.record_success(source)
                    self.cache.set(cache_key, result, self.CACHE_TTL)
                    return result
                except Exception as e:
                    self.circuit_breaker.record_failure(source)
        
        raise AllSourcesFailedError(ticker)
```

**Week 3éªŒæ”¶ï¼š**
- âœ… NewsAgentå¯ç‹¬ç«‹è°ƒç”¨ï¼Œè¾“å‡ºç¬¦åˆAgentOutput
- âœ… PriceAgentå¤šæºå›é€€æ­£å¸¸ï¼Œç†”æ–­ç”Ÿæ•ˆ
- âœ… ä¸¤ä¸ªAgentçš„ç¼“å­˜ç‹¬ç«‹ç”Ÿæ•ˆ

---

#### Week 4ï¼šTechnicalAgent + FundamentalAgent + Orchestrator

##### `technical_agent.py`
- **èŒè´£ï¼š** æŠ€æœ¯æŒ‡æ ‡åˆ†æï¼ˆMA/RSI/MACD/æ”¯æ’‘é˜»åŠ›ï¼‰
- **å·¥å…·ï¼š** get_kline_data, æŠ€æœ¯æŒ‡æ ‡è®¡ç®—å‡½æ•°
- **TTLï¼š** 300ç§’

##### `fundamental_agent.py`
- **èŒè´£ï¼š** è´¢æŠ¥ã€ä¼°å€¼ã€ç›ˆåˆ©åˆ†æ
- **å·¥å…·ï¼š** get_financial_statements, get_key_metrics
- **TTLï¼š** 3600ç§’

##### `orchestrator.py`
```python
class Orchestrator:
    def __init__(self, agents: Dict[str, BaseFinancialAgent]):
        self.agents = agents
        self.forum = ForumHost()
    
    async def analyze(self, query: str, ticker: str) -> ForumOutput:
        # 1. å¹¶è¡Œè°ƒç”¨å¸¸é©»Agent
        tasks = [
            self.agents["price"].research(query, ticker),
            self.agents["news"].research(query, ticker),
            self.agents["technical"].research(query, ticker),
            self.agents["fundamental"].research(query, ticker),
        ]
        outputs = await asyncio.gather(*tasks, return_exceptions=True)
        
        # 2. è¿‡æ»¤å¤±è´¥çš„
        valid_outputs = {
            name: out for name, out in zip(self.agents.keys(), outputs)
            if not isinstance(out, Exception)
        }
        
        # 3. Forumç»¼åˆ
        return await self.forum.synthesize(valid_outputs)
```

##### `forum.py`
```python
class ForumHost:
    SYNTHESIS_PROMPT = """
    ä½ æ˜¯é‡‘èç ”ç©¶ä¸»æŒäººã€‚æ ¹æ®å„Agentåˆ†æç»“æœç”Ÿæˆç»¼åˆæŠ¥å‘Šï¼š
    
    ## ä»·æ ¼Agent: {price}
    ## æ–°é—»Agent: {news}
    ## æŠ€æœ¯Agent: {technical}
    ## åŸºæœ¬é¢Agent: {fundamental}
    
    è¾“å‡ºï¼š
    1. ã€å…±è¯†è§‚ç‚¹ã€‘å„Agentä¸€è‡´è®¤åŒçš„ç»“è®º
    2. ã€åˆ†æ­§è§‚ç‚¹ã€‘å­˜åœ¨å†²çªçš„åˆ¤æ–­åŠåŸå› 
    3. ã€ç½®ä¿¡åº¦ã€‘æ ¹æ®æ•°æ®è´¨é‡ç»™å‡º0-1åˆ†æ•°
    4. ã€æŠ•èµ„å»ºè®®ã€‘BUY/HOLD/SELLåŠç†ç”±
    5. ã€é£é™©æç¤ºã€‘å…³é”®é£é™©å› ç´ 
    """
    
    async def synthesize(self, outputs: Dict[str, AgentOutput]) -> ForumOutput:
        # å†²çªæ£€æµ‹
        conflicts = self._detect_conflicts(outputs)
        # LLMç»¼åˆ
        result = await self.llm.generate(self.SYNTHESIS_PROMPT.format(**outputs))
        return ForumOutput(...)
```

**Week 4éªŒæ”¶ï¼š**
- âœ… 4ä¸ªå¸¸é©»Agentéƒ½å¯ç‹¬ç«‹è°ƒç”¨
- âœ… Orchestratorå¹¶è¡Œè°ƒç”¨æˆåŠŸ
- âœ… Forumèƒ½è¯†åˆ«å†²çªå¹¶ç»™å‡ºç»¼åˆç»“è®º
- âœ… å…¸å‹æŸ¥è¯¢è§¦å‘â‰¥2ä¸ªAgent

---

#### é˜¶æ®µ1éªŒæ”¶æ ‡å‡†ï¼š
- âœ… `backend/agents/`ç›®å½•åŒ…å«5ä¸ªæ–‡ä»¶
- âœ… AgentOutputæ•°æ®ç±»å®šä¹‰å®Œæ•´
- âœ… åæ€å¾ªç¯åœ¨NewsAgentä¸­ç”Ÿæ•ˆ
- âœ… Orchestratorå¹¶è¡Œè°ƒç”¨è€—æ—¶<å•Agentä¸²è¡Œ
- âœ… Forumè¾“å‡ºåŒ…å«å…±è¯†/åˆ†æ­§/å»ºè®®

---

### é˜¶æ®µ2ï¼šIR + æŒ‰éœ€Agent + å‰ç«¯å±•ç¤ºï¼ˆç¬¬5-6å‘¨ï¼‰

#### Week 5ï¼šIR Schema + DeepSearchAgent + MacroAgent

##### `backend/report/ir.py`
```python
from pydantic import BaseModel, validator
from typing import List, Optional
from datetime import datetime

class EvidenceItem(BaseModel):
    text: str
    source: str
    url: Optional[str]
    confidence: float

class Section(BaseModel):
    title: str
    key_points: List[str]
    evidence: List[EvidenceItem]
    agent_source: str

class ReportIR(BaseModel):
    ticker: str
    report_title: str
    generated_at: datetime
    data_as_of: datetime
    
    executive_summary: str
    recommendation: str  # BUY/HOLD/SELL
    confidence: float
    
    sections: List[Section]
    risks: List[str]
    data_sources: List[str]
    fallback_used: bool
    
    @validator('sections')
    def must_have_sections(cls, v):
        if len(v) < 2:
            raise ValueError('æŠ¥å‘Šè‡³å°‘éœ€è¦2ä¸ªç« èŠ‚')
        return v
    
    @validator('confidence')
    def confidence_range(cls, v):
        if not 0 <= v <= 1:
            raise ValueError('ç½®ä¿¡åº¦å¿…é¡»åœ¨0-1ä¹‹é—´')
        return v

class IRRenderer:
    def to_markdown(self, ir: ReportIR) -> str: ...
    def to_html(self, ir: ReportIR) -> str: ...
```

##### `deep_search_agent.py`
- **è§¦å‘æ¡ä»¶ï¼š** ä¸»é“¾è·¯ä¿¡æ¯ä¸è¶³ï¼ˆæ–°é—»<3æ¡ æˆ– as_of>24å°æ—¶ï¼‰
- **èŒè´£ï¼š** é«˜å¬å›æŠ“å–é•¿æ–‡ã€ç ”æŠ¥ã€æ·±åº¦åˆ†æ
- **å·¥å…·ï¼š** Tavilyæ·±åº¦æœç´¢ã€ç½‘é¡µçˆ¬è™«
- **è¾“å‡ºï¼š** å†™å…¥KVä¾›åç»­å¤ç”¨

##### `macro_agent.py`
- **è§¦å‘æ¡ä»¶ï¼š** æŸ¥è¯¢æ¶‰åŠå®è§‚å› ç´ ï¼ˆåˆ©ç‡ã€é€šèƒ€ã€æ”¿ç­–ï¼‰
- **èŒè´£ï¼š** å®è§‚ç¯å¢ƒã€äº‹ä»¶æ—¥å†ã€é£é™©æš´éœ²
- **å·¥å…·ï¼š** searchå®è§‚å…³é”®è¯ã€ç»æµæ•°æ®API

---

#### Week 6ï¼šå‰ç«¯å±•ç¤º + ç«¯åˆ°ç«¯æµ‹è¯•

**å‰ç«¯æ”¹åŠ¨**
- æŠ¥å‘Šç»“æ„åŒ–å±•ç¤ºï¼ˆç« èŠ‚å¯æŠ˜å ï¼‰
- Agentè´¡çŒ®æ ‡è®°ï¼ˆä¾§æ æ˜¾ç¤ºå“ªäº›Agentå‚ä¸ï¼‰
- è¯æ®é“¾æ¥å¯ç‚¹å‡»
- ç½®ä¿¡åº¦å¯è§†åŒ–ï¼ˆè¿›åº¦æ¡ï¼‰
- é£é™©æç¤ºé«˜äº®

**ç«¯åˆ°ç«¯æµ‹è¯•**
```python
# test/test_e2e_multi_agent.py

async def test_full_analysis_pipeline():
    """å®Œæ•´åˆ†ææµç¨‹"""
    result = await orchestrator.analyze("åˆ†æAAPLæŠ•èµ„ä»·å€¼", "AAPL")
    
    assert result.agents_used >= 2
    assert result.recommendation in ["BUY", "HOLD", "SELL"]
    assert 0 <= result.confidence <= 1
    assert len(result.sections) >= 2
    assert all(s.evidence for s in result.sections)

async def test_fallback_to_deep_search():
    """ä¿¡æ¯ä¸è¶³æ—¶è§¦å‘DeepSearch"""
    # æ¨¡æ‹ŸNewsAgentè¿”å›ç©º
    result = await orchestrator.analyze("åˆ†ææŸå†·é—¨è‚¡", "OBSCURE")
    
    assert "DeepSearchAgent" in result.agents_used

async def test_ir_validation():
    """IRæ ¡éªŒ"""
    ir = ReportIR(...)
    assert ir.confidence >= 0
    assert len(ir.sections) >= 2
```

---

#### é˜¶æ®µ2éªŒæ”¶æ ‡å‡†ï¼š
- âœ… IR Schemaå®šä¹‰å®Œæ•´ï¼ŒPydanticæ ¡éªŒé€šè¿‡ç‡>95%
- âœ… DeepSearchAgentæŒ‰éœ€è§¦å‘æ­£å¸¸
- âœ… MacroAgentå¯¹å®è§‚é—®é¢˜å“åº”
- âœ… å‰ç«¯æŠ¥å‘Šå¯æŠ˜å /å±•å¼€ç« èŠ‚
- âœ… Agentè´¡çŒ®å¯è§
- âœ… è¯æ®é“¾æ¥å¯ç‚¹å‡»
- âœ… ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡

---

## å››ã€å…³é”®ä»£ç è·¯å¾„æ±‡æ€»

```
backend/
â”œâ”€â”€ agents/                    # é˜¶æ®µ1æ–°å»º
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_agent.py         # AgentOutput + BaseFinancialAgent
â”‚   â”œâ”€â”€ price_agent.py        # è¡Œæƒ…Agent
â”‚   â”œâ”€â”€ news_agent.py         # æ–°é—»Agentï¼ˆå«åæ€å¾ªç¯ï¼‰
â”‚   â”œâ”€â”€ technical_agent.py    # æŠ€æœ¯Agent
â”‚   â”œâ”€â”€ fundamental_agent.py  # åŸºæœ¬é¢Agent
â”‚   â”œâ”€â”€ macro_agent.py        # å®è§‚Agentï¼ˆæŒ‰éœ€ï¼‰
â”‚   â””â”€â”€ deep_search_agent.py  # æ·±åº¦æœç´¢Agentï¼ˆæŒ‰éœ€ï¼‰
â”œâ”€â”€ orchestration/
â”‚   â”œâ”€â”€ orchestrator.py       # å¹¶è¡Œè°ƒç”¨+ç»“æœæ”¶é›†
â”‚   â””â”€â”€ forum.py              # ForumHostå†²çªæ¶ˆè§£
â”œâ”€â”€ report/
â”‚   â””â”€â”€ ir.py                 # ReportIR + IRRenderer
â”œâ”€â”€ services/                  # é˜¶æ®µ0æ–°å»º
â”‚   â”œâ”€â”€ cache.py              # KVç¼“å­˜
â”‚   â””â”€â”€ circuit_breaker.py    # ç†”æ–­å™¨
â”œâ”€â”€ tools.py                   # é˜¶æ®µ0æ”¹é€ ï¼ˆè¾“å‡ºæ ‡å‡†åŒ–ï¼‰
â””â”€â”€ langchain_agent.py         # é˜¶æ®µ0æ”¹é€ ï¼ˆtracingï¼‰

frontend/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Diagnostics.tsx       # é˜¶æ®µ0æ–°å»º
â”‚   â”œâ”€â”€ ReportView.tsx        # é˜¶æ®µ2æ”¹é€ ï¼ˆIRå±•ç¤ºï¼‰
â”‚   â””â”€â”€ AgentBadge.tsx        # é˜¶æ®µ2æ–°å»ºï¼ˆAgentæ ‡è®°ï¼‰

test/
â”œâ”€â”€ test_cache.py             # é˜¶æ®µ0
â”œâ”€â”€ test_circuit_breaker.py   # é˜¶æ®µ0
â”œâ”€â”€ test_fallback.py          # é˜¶æ®µ0
â”œâ”€â”€ test_agents.py            # é˜¶æ®µ1
â”œâ”€â”€ test_orchestrator.py      # é˜¶æ®µ1
â”œâ”€â”€ test_ir.py                # é˜¶æ®µ2
â””â”€â”€ test_e2e_multi_agent.py   # é˜¶æ®µ2
```

---

## äº”ã€æ—¥å¿—å­—æ®µè§„èŒƒ

**æ‰€æœ‰å·¥å…·è°ƒç”¨å¿…é¡»è®°å½•ï¼š**
```json
{
    "timestamp": "2025-12-09T10:30:00.123Z",
    "tool_name": "get_stock_price",
    "ticker": "AAPL",
    "source": "yfinance",
    "duration_ms": 230,
    "cache_hit": false,
    "fallback_used": false,
    "fail_reason": null,
    "result_preview": "price=150.23"
}
```

**Agentè°ƒç”¨è®°å½•ï¼š**
```json
{
    "timestamp": "2025-12-09T10:30:01.456Z",
    "agent_name": "NewsAgent",
    "ticker": "AAPL",
    "reflection_rounds": 2,
    "evidence_count": 5,
    "confidence": 0.85,
    "duration_ms": 3200
}
```

---

## å…­ã€é£é™©ä¸åº”å¯¹

| é£é™© | åº”å¯¹ |
|------|------|
| å¤šAgentå¹¶è¡Œå¯¼è‡´APIé™æµ | ç†”æ–­å™¨+è¯·æ±‚é—´éš”+ä¼˜å…ˆçº§æ’åº |
| åæ€å¾ªç¯æ— é™é€’å½’ | MAX_REFLECTIONSç¡¬é™åˆ¶ |
| IRæ ¡éªŒå¤±è´¥ç‡é«˜ | å…ˆå®½æ¾åæ”¶ç´§ï¼Œè®°å½•å¤±è´¥case |
| Forumå†²çªæ¶ˆè§£ä¸å‡† | ä¿ç•™åŸå§‹Agentè¾“å‡ºä¾›äººå·¥å®¡æ ¸ |
| å‰ç«¯æ¸²æŸ“å¤æ‚åº¦ | åˆ†é˜¶æ®µï¼šå…ˆæ–‡æœ¬â†’å†æŠ˜å â†’å†å¯è§†åŒ– |

---

## ä¸ƒã€éªŒæ”¶Checklistæ€»è§ˆ

### é˜¶æ®µ0ï¼ˆç¬¬1-2å‘¨ï¼‰
- âœ… tools.pyæ‰€æœ‰å‡½æ•°è¿”å›æ ‡å‡†schema
- âœ… cache.pyå®ç°ä¸”TTLå¯é…ç½®
- âœ… circuit_breaker.pyä¸‰çŠ¶æ€æœºæ­£å¸¸
- âœ… æœç´¢å…œåº•Tavilyå¯ç”¨
- âœ… LangSmithå¯è§tracing
- âœ… å‰ç«¯Diagnosticsé¢æ¿å¯ç”¨

### é˜¶æ®µ1ï¼ˆç¬¬3-4å‘¨ï¼‰
- âœ… 4ä¸ªå¸¸é©»Agentå®šä¹‰å®Œæˆ
- âœ… AgentOutputæ•°æ®ç±»å¯ç”¨
- âœ… åæ€å¾ªç¯åœ¨NewsAgentç”Ÿæ•ˆ
- âœ… Orchestratorå¹¶è¡Œè°ƒç”¨æ­£å¸¸
- âœ… ForumHostè¾“å‡ºç»“æ„åŒ–ç»¼åˆ

### é˜¶æ®µ2ï¼ˆç¬¬5-6å‘¨ï¼‰
- âœ… ReportIR Pydanticæ ¡éªŒé€šè¿‡
- âœ… DeepSearchAgentæŒ‰éœ€è§¦å‘
- âœ… å‰ç«¯æŠ¥å‘Šç« èŠ‚å¯æŠ˜å 
- âœ… Agentè´¡çŒ®å¯è§
- âœ… ç«¯åˆ°ç«¯æµ‹è¯•å…¨é€šè¿‡

---

**å®Œæˆä»¥ä¸Šå…¨éƒ¨ï¼ŒFinSightå°†ä»ã€Œå•Agent+å·¥å…·ã€å‡çº§ä¸ºã€Œå¤šAgentåä½œ+åæ€å¾ªç¯+IRç»“æ„åŒ–+KVç¼“å­˜ã€çš„ä¸“ä¸šé‡‘èç ”ç©¶å¹³å°ã€‚**


ğŸ“Š é¡¹ç›®å½“å‰é˜¶æ®µè¯„ä¼°
âœ… é˜¶æ®µ0 å·²åŸºæœ¬å®Œæˆï¼ˆçº¦ 85%ï¼‰
ä»»åŠ¡	çŠ¶æ€	è¯æ®
KV ç¼“å­˜	âœ… å®Œæˆ	cache.py - DataCache ç±»å·²å®ç°ï¼Œæ”¯æŒ TTLã€çº¿ç¨‹å®‰å…¨ã€å‘½ä¸­ç»Ÿè®¡
å·¥å…·ç¼–æ’å™¨	âœ… å®Œæˆ	orchestrator.py - ToolOrchestrator å·²å®ç°å¤šæºå›é€€ã€ä¼˜å…ˆçº§æ’åºã€å¥åº·æ£€æµ‹
FetchResult æ ‡å‡†åŒ–	âœ… å®Œæˆ	åŒ…å« success/data/source/cached/duration_ms/as_of/fallback_used/tried_sources/trace
å¥åº·æ¢æµ‹	âœ… å®Œæˆ	health_probe.py - å®šæœŸ ping æ•°æ®æº
æ•°æ®æ ¡éªŒ	âœ… å®Œæˆ	validator.py
å‰ç«¯è¯Šæ–­é¢æ¿	âœ… å®Œæˆ	DiagnosticsPanel.tsx - æ˜¾ç¤º LangGraph å’Œ Orchestrator çŠ¶æ€
æµ‹è¯•è¦†ç›–	âœ… åŸºæœ¬å®Œæˆ	test_cache.py, test_orchestrator.py, test_phase1_integration.py ç­‰
é˜¶æ®µ0 å°šæœªå®Œæˆçš„éƒ¨åˆ†ï¼š
ä»»åŠ¡	çŠ¶æ€	è¯´æ˜
ç†”æ–­å™¨ CircuitBreaker	âŒ ç¼ºå¤±	backend/services/circuit_breaker.py ä¸å­˜åœ¨ï¼Œç†”æ–­é€»è¾‘åœ¨ orchestrator é‡Œç”¨ fail_rate ç®€åŒ–å®ç°
æœç´¢å…œåº•ç‹¬ç«‹èŠ‚ç‚¹	âš ï¸ éƒ¨åˆ†	_search_for_price å­˜åœ¨ä½†æœªä½œä¸ºç‹¬ç«‹å…œåº•å±‚
LangSmith tracing æ‰“ç‚¹	âš ï¸ éƒ¨åˆ†	langsmith_integration.py å­˜åœ¨ä½†æœªè§èŠ‚ç‚¹çº§ tracing
ğŸš§ é˜¶æ®µ1 å°šæœªå¼€å§‹ï¼ˆ0%ï¼‰
ä»»åŠ¡	çŠ¶æ€	è¯´æ˜
backend/agents/ ç›®å½•	âŒ ä¸å­˜åœ¨	æ²¡æœ‰ base_agent.py, news_agent.py, price_agent.py ç­‰
AgentOutput æ•°æ®ç±»	âŒ ä¸å­˜åœ¨	æ²¡æœ‰å®šä¹‰å­ Agent çš„æ ‡å‡†è¾“å‡ºç»“æ„
åæ€å¾ªç¯ Reflection	âŒ ä¸å­˜åœ¨	æ²¡æœ‰ ReflectionNode å®ç°
ForumHost å†²çªæ¶ˆè§£	âŒ ä¸å­˜åœ¨	æ²¡æœ‰å¤š Agent ç»“æœèåˆæœºåˆ¶
ğŸ”® é˜¶æ®µ2 å°šæœªå¼€å§‹ï¼ˆ0%ï¼‰
ä»»åŠ¡	çŠ¶æ€
IR Schema (ReportIR)	âŒ ä¸å­˜åœ¨
IRRenderer	âŒ ä¸å­˜åœ¨
DeepSearchAgent	âŒ ä¸å­˜åœ¨
MacroAgent	âŒ ä¸å­˜åœ¨
ğŸ“ æ€»ç»“
æ•´ä½“è¿›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ çº¦ 30%

é˜¶æ®µ0ï¼ˆåŸºåº§å¼ºåŒ–ï¼‰: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–’â–‘ 85% - ç¼ºç†”æ–­å™¨ç‹¬ç«‹å®ç°
é˜¶æ®µ1ï¼ˆå­Agenté›å½¢ï¼‰: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0% - å°šæœªå¼€å§‹
é˜¶æ®µ2ï¼ˆIR+æŒ‰éœ€Agentï¼‰: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0% - å°šæœªå¼€å§‹
ğŸ¯ å½“å‰çŠ¶æ€ä¸€å¥è¯ï¼š
é¡¹ç›®å·²å®Œæˆã€Œå·¥å…·ç¼–æ’å±‚ + ç¼“å­˜ + è¯Šæ–­é¢æ¿ã€çš„åŸºç¡€è®¾æ–½ï¼Œä½†ã€Œå¤š Agent æ¶æ„ã€å°šæœªå¯åŠ¨ã€‚ä¸‹ä¸€æ­¥åº”è¯¥åˆ›å»º backend/agents/ ç›®å½•å¹¶å®ç° BaseAgent + ç¬¬ä¸€ä¸ªå­ Agentï¼ˆå»ºè®®ä» NewsAgent æˆ– PriceAgent å¼€å§‹ï¼‰ã€‚

ğŸš€ ç«‹å³è¡ŒåŠ¨å»ºè®®
è¡¥å®Œé˜¶æ®µ0ï¼ˆ1-2å¤©ï¼‰ï¼š

åˆ›å»º backend/services/circuit_breaker.py ç‹¬ç«‹ç†”æ–­å™¨
åœ¨ langchain_agent.py å¢åŠ èŠ‚ç‚¹çº§ tracing
å¯åŠ¨é˜¶æ®µ1ï¼ˆæœ¬å‘¨ï¼‰ï¼š

åˆ›å»º backend/agents/__init__.py
å®ç° backend/agents/base_agent.pyï¼ˆå®šä¹‰ AgentOutput æ•°æ®ç±»ï¼‰
å®ç°ç¬¬ä¸€ä¸ªå­ Agentï¼šPriceAgentï¼ˆæœ€ç®€å•ï¼Œå¤ç”¨ç°æœ‰ orchestratorï¼‰

### æ›´æ–° 2025-12-10 22:56
- æ–°å¢ `backend/services/circuit_breaker.py`ï¼Œæ”¯æŒ CLOSED/OPEN/HALF_OPEN çŠ¶æ€ã€æ¢å¤è¶…æ—¶ä¸æ¢æµ‹æˆåŠŸé‡ç½®ã€‚
- Orchestrator æ³¨å…¥ç†”æ–­ï¼Œå¤±è´¥è®°å½•ä¼šæ‰“å¼€ç”µè·¯ï¼Œ`get_stats` å±•ç¤º circuit_state/skip_reasonï¼›æ•°æ®æºéªŒè¯/ç¼“å­˜ç»Ÿè®¡ä¿æŒåŸæœ‰è¡Œä¸ºã€‚
- LangGraph è§‚æµ‹æ€§å¢å¼ºï¼š`FinancialAnalysisCallback` è®°å½• tool_start/tool_end äº‹ä»¶å¹¶å¸¦è€—æ—¶ï¼ŒAgent è¿”å› trace/duration metadataï¼Œ`describe_report_agent` å±•ç¤º recent_trace è¯Šæ–­ã€‚
- æµ‹è¯•ï¼š`python backend/tests/test_circuit_breaker.py`ï¼›`python backend/tests/test_orchestrator.py`ã€‚
- ä¸‹ä¸€æ­¥ï¼šç»Ÿä¸€ `tools.py` è¾“å‡º schema + cache/log è®°å½•ï¼Œåˆ›å»º `backend/agents/` (Base/Price/News) å¯åŠ¨é˜¶æ®µ1ã€‚

### æ›´æ–° 2025-12-27 - Bug ä¿®å¤ä¸æµå¼è¾“å‡º

#### ğŸ› Bug ä¿®å¤

**1. FinancialAnalysisCallback NoneType é”™è¯¯**
- **é—®é¢˜**: `on_chain_start` å’Œ `on_tool_start` ä¸­ `serialized` å‚æ•°å¯èƒ½ä¸º Noneï¼Œå¯¼è‡´ `'NoneType' object has no attribute 'get'`
- **ä¿®å¤**: æ·»åŠ ç©ºå€¼æ£€æŸ¥
```python
name = "chain"
if serialized and isinstance(serialized, dict):
    name = serialized.get("name", "chain")
```

**2. LangGraph å·¥å…·è°ƒç”¨æ­»å¾ªç¯**
- **é—®é¢˜**: å·¥å…·è¢«é‡å¤è°ƒç”¨ 31+ æ¬¡ï¼Œå¤±è´¥çš„å·¥å…·ä¸æ–­é‡è¯•
- **ä¿®å¤**:
  - æ·»åŠ  `guarded_tools_condition` å‡½æ•°ï¼Œé™åˆ¶æœ€å¤§å·¥å…·è°ƒç”¨æ¬¡æ•°ä¸º 8
  - å®ç°å·¥å…·è°ƒç”¨å“ˆå¸Œå»é‡ï¼ˆ`call_tracker["called"]`ï¼‰
  - è®°å½•å¤±è´¥å·¥å…·å¹¶è·³è¿‡ï¼ˆ`call_tracker["failed"]`ï¼‰
  - æ¯æ¬¡æ–°æŸ¥è¯¢é‡ç½®è¿½è¸ªå™¨

**3. Wikipedia æœç´¢é‡‘èæŸ¥è¯¢**
- **é—®é¢˜**: è‚¡ç¥¨æŸ¥è¯¢æ—¶ä¸åº”æœç´¢ Wikipedia
- **ä¿®å¤**: åœ¨ `tools.py` çš„ search å‡½æ•°ä¸­æ·»åŠ é‡‘èå…³é”®è¯æ£€æµ‹ï¼Œè·³è¿‡ Wikipedia

#### âœ¨ æ–°åŠŸèƒ½ï¼šæµå¼è¾“å‡º (SSE)

- **åç«¯**: `langchain_agent.py` æ–°å¢ `analyze_stream` æ–¹æ³•ï¼Œä½¿ç”¨ `astream_events` é€å­—è¾“å‡º
- **API**: `backend/api/main.py` æ›´æ–° `/chat/stream` ç«¯ç‚¹
- **å‰ç«¯**: `client.ts` æ–°å¢ `sendMessageStream`ï¼Œ`ChatInput.tsx` é›†æˆæµå¼æ˜¾ç¤º
- **æ–‡æ¡£**: `docs/05_STREAMING_IMPLEMENTATION.md`

#### ğŸ“ ä¿®æ”¹æ–‡ä»¶
- `backend/langchain_agent.py` - Callback ä¿®å¤ + å·¥å…·è°ƒç”¨é™åˆ¶ + æµå¼è¾“å‡º
- `backend/api/main.py` - SSE ç«¯ç‚¹
- `backend/tools.py` - Wikipedia è¿‡æ»¤
- `frontend/src/api/client.ts` - æµå¼æ¥æ”¶
- `frontend/src/components/ChatInput.tsx` - é€å­—æ˜¾ç¤º
