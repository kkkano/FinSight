# P0 执行记录（2026-01-09）

## 条目 1：/chat/stream 非 REPORT 真正 token 流式输出
- 时间：2026-01-09 12:32:11
- 目标：CHAT/FOLLOWUP 走真实 LLM token streaming，取消按句子切块的伪流式
- 变更：
  - 新增 ChatHandler.stream_with_llm / FollowupHandler.stream_with_llm
  - /chat/stream 对 CHAT/FOLLOWUP 使用真实 token 输出，并在末尾补 chart marker（如有）
  - 新增单元测试覆盖 chat/followup 流式输出
- 测试：
  - `python -m pytest backend/tests/test_streaming_chat_followup.py`
  - 结果：通过（pytest-asyncio 有一个 deprecation warning，未影响通过）
- 当前项目情况：
  - REPORT：已有真实流式（report_agent.analyze_stream）
  - CHAT/FOLLOWUP：已改为 token 级流式；无流式能力时回退为单次输出
  - /chat/stream：仍未接入 Supervisor 聚合与指代消解（待后续）
- 下一步动作：
  1) /chat/stream 接入 Supervisor 或提供等价报告流式聚合
  2) REPORT 意图稳定性与无 ticker 澄清优化
  3) /chat/stream 增加指代消解（resolve_reference）

## 条目 2：/chat/stream 接入 Supervisor 流式聚合
- 时间：2026-01-09 13:17:44
- 目标：REPORT 在 /chat/stream 走 Supervisor analyze_stream，并在 done 事件附带 ReportIR
- 变更：
  - 新增 `stream_supervisor_sse`，将 Supervisor 事件转成 SSE
  - /chat/stream REPORT 优先使用 Supervisor 流式聚合（有 ticker 时）
  - done 事件附带简化 ReportIR（基于 consensus 生成）
  - 新增单元测试覆盖 Supervisor SSE 辅助函数
- 测试：
  - `python -m pytest backend/tests/test_streaming_sse.py`
  - 结果：通过（pytest-asyncio 有一个 deprecation warning，未影响通过）
- 当前项目情况：
  - REPORT：/chat 使用 Supervisor；/chat/stream 优先 Supervisor 流式
  - CHAT/FOLLOWUP：已为真实 token 流式
  - /chat/stream：仍未做指代消解
- 下一步动作：
  1) REPORT 意图稳定性与无 ticker 澄清优化
  2) /chat/stream 增加指代消解（resolve_reference）

## 条目 3：REPORT 意图稳定性 + /chat/stream 指代消解
- 时间：2026-01-09 14:35:44
- 目标：提升中文 REPORT 识别稳定性，优化无 ticker 澄清，并让 /chat/stream 与 /chat 一致走指代消解
- 变更：
  - Router 报告关键词扩展 + 金融上下文判断
  - ReportHandler 无 ticker 澄清提示优化（包含公司名提示）
  - /chat/stream 增加 resolve_reference，并在后续链路使用 resolved_query
  - 新增单元测试：report intent 稳定性、stream 指代消解
- 测试：
  - `python -m pytest backend/tests/test_router_report_intent.py backend/tests/test_streaming_reference_resolution.py`
  - 结果：通过（pytest-asyncio 有一个 deprecation warning，未影响通过）
- 当前项目情况：
  - REPORT：意图识别覆盖研报/投研/估值/基本面等表述
  - /chat/stream：已与 /chat 一致走指代消解
- 下一步动作：
  1) TechnicalAgent + FundamentalAgent
  2) DeepSearchAgent 真实检索 + PDF 解析

## 条目 4：对话体验修复（行情澄清/新闻时效/思考链路乱码）
- 时间：2026-01-09 15:54:04
- 目标：修复行情类澄清与新闻时效问题，并消除思考链路中的乱码问号。
- 变更：
  - 行情无 ticker 时返回澄清提示，且“最近+行情”优先走价格查询
  - 价格查询在 Orchestrator 失败时回退到 tools 与 K 线收盘价兜底
  - 市场/个股新闻增加时效解析与反思重试，返回可点击链接
  - 新闻列表类返回跳过 LLM 改写，减少时效飘移
  - chat_async 思考提示与前端 Reasoning trace 图标采用 ASCII，消除乱码
- 测试：
  - `python -m pytest backend/tests/test_chat_price_clarification.py`
  - `python -m pytest backend/tests/test_news_parsing.py`
  - `python -m pytest backend/tests/test_thinking_messages.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 当前项目情况：
  - 行情查询：无 ticker 会追问，失败时回退到收盘价
  - 新闻热点：优先 48h/7d 可验证链接，不能确认时提示时效不确定
  - 思考链路：文本可读且前端浏览不出现问号
- 下一步动作：
  1) 在真实调用中验证新闻时效与价格兜底链路
  2) 评估引入子 agent 实现 Self-RAG/多源交叉验证

## 条目 5：行情识别与图表触发修正
- 时间：2026-01-09 16:37:50
- 目标：解决“行情不识别/不弹图表”的体验问题，保持澄清回复不被 LLM 改写。
- 变更：
  - 澄清类响应不再进行 LLM 改写，保持“请给出代码/公司名”的追问
  - 图表触发关键词增加“行情/价格/股价/现价”，行情类问题优先展示图表
- 测试：
  - `python -m pytest backend/tests/test_chart_detector.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 当前项目情况：
  - “实时行情查询”类问题会直接追问具体标的
  - “谷歌最近行情如何”会进入图表触发流程
- 下一步动作：
  1) 运行前端回归并对比最终用户显示与返回链路

## 条目 6：市场热点时效性加强
- 时间：2026-01-09 16:52:34
- 目标：提升市场热点返回的时效性与准确性，避免无日期或过期链接误导。
- 变更：
  - 新闻获取加入 SPY/QQQ/DIA/IWM 全局主要 ETF 源
  - Exa 搜索结果附加发布日期，并支持从 URL 解析日期
  - 市场热点先用 3 天严格时效窗口，失败后放宽到 7 天，仍无有效资讯则直接提示无最近热点
- 测试：
  - `python -m pytest backend/tests/test_news_parsing.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 当前项目情况：
  - 市场热点会优先使用有日期且在窗口内的链接，防止过期内容误导

## 条目 7：市场热点引入 RSS/Finnhub 官方源
- 时间：2026-01-09 16:58:09
- 目标：提升官方源时效性，减少检索的无日期链接。
- 变更：
  - 添加 Reuters RSS 作为默认官方源，支持 BLOOMBERG_RSS_URLS 环境变量扩展
  - 添加 Finnhub general_news 作为 48h 时效源
  - RSS/URL 日期解析用于过期过滤
- 测试：
  - `python -m pytest backend/tests/test_rss_parsing.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）

## 条目 8：Bloomberg RSS 默认源与文档同步
- 时间：2026-01-09 17:29:18
- 目标：将 Bloomberg RSS 列表纳入默认官方源，并同步更新 README 与 01-05/ROADMAP 文档说明。
- 变更：
  - get_market_news_headlines 默认启用 Bloomberg RSS 列表，并保留 BLOOMBERG_RSS_URLS 扩展。
  - 文档补充官方 RSS 来源与 48h/7d 时效过滤说明，README 增加默认 Bloomberg feed 列表与环境变量。
- 测试：
  - `python -m pytest backend/tests/test_rss_parsing.py backend/tests/test_news_parsing.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 当前项目情况：
  - 市场热点优先 RSS（Reuters/Bloomberg）+ Finnhub 48h，搜索兜底保留时效过滤。
- 下一步动作：
  1) 继续验证真实环境下的新闻时效与来源覆盖
  2) 评估引入反思循环/子 agent 进一步校验时效性

## 条目 9：回归“市场热点”请求 + 更新 readme_cn
- 时间：2026-01-09 17:41:33
- 目标：在真实服务回归“最近市场热点”并确认 RSS 链接日期与时效展示，同时补充中文 README。
- 变更：
  - readme_cn.md 增加市场新闻来源说明与 BLOOMBERG_RSS_URLS 环境变量说明。
- 回归：
  - /chat/stream 请求“最近市场热点是什么”和“市场热点 新闻”均返回澄清提示，未进入市场新闻链路，无法确认 RSS 日期展示。
- 当前项目情况：
  - 市场热点的 RSS/Finnhub 时效链路已接入，但中文“热点”类请求仍可能被路由为 CLARIFY。
- 下一步动作：
  1) 在 Router/ChatHandler 加强“市场热点/市场新闻”关键词的 CHAT 识别
  2) 回归确认 RSS 链接日期与时效展示

## 条目 10：市场热点意图识别修复 + 回归验证
- 时间：2026-01-09 17:51:31
- 目标：修正 Router 对“市场热点/市场新闻”类问题的 CHAT 识别，并回归验证 RSS 日期展示。
- 变更：
  - Router 增加市场新闻/热点关键词匹配，未命中 LLM 时也能进入 CHAT。
  - financial_keywords 增加“市场/新闻/热点/快讯/头条”等金融上下文词。
  - 新增单测覆盖市场热点意图。
- 测试：
  - `python -m pytest backend/tests/test_router_market_news_intent.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 回归：
  - /chat/stream 提问“最近市场热点是什么”返回“最近48小时市场要闻(RSS)”并包含 2026-01-09 日期的 Bloomberg 链接。
- 当前项目情况：
  - 市场热点已能稳定进入市场新闻链路，RSS 日期可被展示。
- 下一步动作：
  1) 继续观察 Reuters RSS 与 Bloomberg RSS 混合时的覆盖与时效
  2) 评估加入更严格的“市场热点”时效阈值提示

## 条目 11：规则优先 + LLM 兜底优化
- 时间：2026-01-09 18:06:25
- 目标：保持规则优先的稳定性，同时在需要澄清且带金融语境时启用 LLM 兜底。
- 变更：
  - Router 仅在 quick_match 为 CLARIFY 且带金融上下文时尝试 LLM 重新判别。
  - 保留规则优先的短路路径，避免非金融问题误触发 LLM。
- 测试：
  - `python -m pytest backend/tests/test_router_market_news_intent.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 回归：
  - /chat/stream 提问“最近市场热点是什么”返回“最近48小时市场要闻(RSS)”并包含 2026-01-09 日期的 Bloomberg 链接。
- 当前项目情况：
  - 规则优先 + LLM 兜底已生效，市场热点链路正常输出 RSS 日期与链接。
- 下一步动作：
  1) 评估是否对“无上下文追问”加入更友好澄清文案
  2) 扩展 LLM 兜底的可观测日志

## 条目 12：无上下文追问澄清文案 + LLM 兜底日志
- 时间：2026-01-09 18:12:34
- 目标：提供更友好的“无上下文追问”澄清文案，并增加 LLM 兜底可观测日志。
- 变更：
  - Router 在无上下文追问时标记 clarify_reason=followup_without_context。
  - Clarify 响应改为引导用户补充具体标的/话题。
  - LLM 兜底日志记录触发原因、输入与输出意图。
- 测试：
  - `python -m pytest backend/tests/test_router_clarify_fallback.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 当前项目情况：
  - 追问类无上下文提示更友好，LLM 兜底触发路径可观测。
- 下一步动作：
  1) 根据真实对话样本调整澄清文案措辞
  2) 评估在日志中加入 session_id/trace_id

## 条目 13：InlineChart 重复加载修复
- 时间：2026-01-09 21:32:19
- 目标：修复报告/聊天渲染时图表闪烁与 K 线重复请求的问题。
- 变更：
  - InlineChart 使用 ref 缓存 onDataReady，避免回调变化触发重复拉取。
  - 增加 summary 去重，避免重复上报 chart summary。
- 测试：
  - 未新增前端自动化测试（当前无对应测试框架）。
- 当前项目情况：
  - K 线请求应仅在 ticker/period 变更时触发，减少闪烁与频繁请求。
- 下一步动作：
  1) 手动回归报告流式生成，确认闪烁消失
  2) 排查 /api/chart/detect 的重复触发是否仍存在

## 条目 14：报告流式默认切换至 ReportAgent
- 时间：2026-01-09 21:43:38
- 目标：避免 Supervisor 占位输出导致“空壳报告”，默认使用 ReportAgent 生成完整报告；保留强制使用 Supervisor 的开关。
- 变更：
  - /chat/stream 在 report_agent 可用时优先走 report_agent；仅在缺失 report_agent 或设置 SUPERVISOR_STREAM_FORCE 时才走 Supervisor。
  - /chat 与异步报告路径仅在缺失 report_agent 或设置 SUPERVISOR_REPORT_FORCE 时才走 Supervisor。
- 测试：
  - `python -m pytest backend/tests/test_chat_supervisor_sync.py backend/tests/test_chat_async_supervisor.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 当前项目情况：
  - 默认报告路径已切换为 ReportAgent，Supervisor 作为可选覆盖路径。
- 下一步动作：
  1) 真实服务回归“用中文生成拼多多综合分析报告”
  2) 如需 Supervisor 聚合输出，设置 SUPERVISOR_STREAM_FORCE/SUPERVISOR_REPORT_FORCE

## 条目 15：报告流式 done 事件保证包含 ReportIR
- 时间：2026-01-09 21:59:40
- 目标：修复报告流式输出仅有纯文本、缺失卡片报告的问题。
- 变更：
  - stream_report_sse 在流结束时统一发送 done 事件，并用完整文本构造 ReportIR。
  - 避免上游 done 丢失导致前端无法渲染卡片。
- 测试：
  - `python -m pytest backend/tests/test_streaming_sse.py`
  - 结果：通过（pytest-asyncio 有一条 deprecation warning，未影响结果）
- 当前项目情况：
  - 报告流式应在结束时稳定返回 report 数据，前端可渲染卡片。
- 下一步动作：
  1) 真实服务回归“用中文生成拼多多综合分析报告”确认卡片恢复
  2) 如仍仅文本，抓取 SSE done 事件检查 report 是否为空
