# P0 执行记录（2026-01-09）

## 条目 1：/chat/stream 非 REPORT 真正 token 流式输出
- 时间：2026-01-09 12:32:11
- 目标：CHAT/FOLLOWUP 走真实 LLM token streaming，取消按句子切块的伪流式
- 变更：
  - 新增 ChatHandler.stream_with_llm / FollowupHandler.stream_with_llm
  - /chat/stream 对 CHAT/FOLLOWUP 使用真实 token 输出，并在末尾补 chart marker（如有）
  - 新增单元测试覆盖 chat/followup 流式输出
- 测试：
  - `python -m pytest backend/tests/test_streaming_chat_followup.py`
  - 结果：通过（pytest-asyncio 有一个 deprecation warning，未影响通过）
- 当前项目情况：
  - REPORT：已有真实流式（report_agent.analyze_stream）
  - CHAT/FOLLOWUP：已改为 token 级流式；无流式能力时回退为单次输出
  - /chat/stream：仍未接入 Supervisor 聚合与指代消解（待后续）
- 下一步动作：
  1) /chat/stream 接入 Supervisor 或提供等价报告流式聚合
  2) REPORT 意图稳定性与无 ticker 澄清优化
  3) /chat/stream 增加指代消解（resolve_reference）

## 条目 2：/chat/stream 接入 Supervisor 流式聚合
- 时间：2026-01-09 13:17:44
- 目标：REPORT 在 /chat/stream 走 Supervisor analyze_stream，并在 done 事件附带 ReportIR
- 变更：
  - 新增 `stream_supervisor_sse`，将 Supervisor 事件转成 SSE
  - /chat/stream REPORT 优先使用 Supervisor 流式聚合（有 ticker 时）
  - done 事件附带简化 ReportIR（基于 consensus 生成）
  - 新增单元测试覆盖 Supervisor SSE 辅助函数
- 测试：
  - `python -m pytest backend/tests/test_streaming_sse.py`
  - 结果：通过（pytest-asyncio 有一个 deprecation warning，未影响通过）
- 当前项目情况：
  - REPORT：/chat 使用 Supervisor；/chat/stream 优先 Supervisor 流式
  - CHAT/FOLLOWUP：已为真实 token 流式
  - /chat/stream：仍未做指代消解
- 下一步动作：
  1) REPORT 意图稳定性与无 ticker 澄清优化
  2) /chat/stream 增加指代消解（resolve_reference）

## 条目 3：REPORT 意图稳定性 + /chat/stream 指代消解
- 时间：2026-01-09 14:35:44
- 目标：提升中文 REPORT 识别稳定性，优化无 ticker 澄清，并让 /chat/stream 与 /chat 一致走指代消解
- 变更：
  - Router 报告关键词扩展 + 金融上下文判断
  - ReportHandler 无 ticker 澄清提示优化（包含公司名提示）
  - /chat/stream 增加 resolve_reference，并在后续链路使用 resolved_query
  - 新增单元测试：report intent 稳定性、stream 指代消解
- 测试：
  - `python -m pytest backend/tests/test_router_report_intent.py backend/tests/test_streaming_reference_resolution.py`
  - 结果：通过（pytest-asyncio 有一个 deprecation warning，未影响通过）
- 当前项目情况：
  - REPORT：意图识别覆盖研报/投研/估值/基本面等表述
  - /chat/stream：已与 /chat 一致走指代消解
- 下一步动作：
  1) TechnicalAgent + FundamentalAgent
  2) DeepSearchAgent 真实检索 + PDF 解析
